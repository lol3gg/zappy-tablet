<!DOCTYPE html>
<html lang="it">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>Zappy ‚Äì Read‚ÄëOnly + Carrello</title>
  <style>
    :root{
      --grad-a:#00c6ff;
      --grad-b:#7d2ae8;
      --bg:#f2f7ff;
      --card:#ffffff;
      --muted:#6b7280;
      --ink:#0f172a;
      --ring:#e5e7f9;
      --shadow:0 10px 24px rgba(0,0,0,.06);
      --radius:16px;
    }
    *{box-sizing:border-box}html,body{height:100%}body{margin:0;background:var(--bg);font-family:Inter,system-ui,-apple-system,Segoe UI,Roboto}
    /* Left app sidebar */
    .sidebar {
      position: fixed;
      inset: 0 auto 0 0;
      width: 82px;
      background: linear-gradient(180deg, var(--grad-a) 0%, var(--grad-b) 100%);
      display: flex;
      flex-direction: column;
      align-items: center;
      justify-content: space-between; /* distribuzione uniforme */
      padding: 16px 10px;
    }
    .sidebar nav {
      display: flex;
      flex-direction: column;
      align-items: center;
      height: 100%;
      justify-content: space-between; /* primo in alto e ultimo in basso */
      padding: 40px 0; /* margine alto/basso */
    }
    .sidebar nav button:nth-child(2) {
      margin: auto 0; /* questo resta al centro verticale */
    }

    .brand{color:#fff;font-weight:700;margin:6px 0 12px}
    .nav-btn{width:56px;height:56px;border:0;border-radius:16px;background:radial-gradient(120% 120% at 20% 20%,rgba(255,255,255,.6),rgba(255,255,255,.15));box-shadow:0 10px 24px rgba(0,0,0,.15);cursor:pointer;display:grid;place-items:center;transition:transform .12s ease}
    .nav-btn:hover{transform:translateY(-2px)}.icon{font-size:22px}
    /* Main grid: content + order pane */
    .main{margin-left:82px;min-height:100vh;display:grid;grid-template-columns:1fr 360px}
    .header{grid-column:1/-1;height:56px;display:flex;align-items:center;padding:0 16px;border-bottom:1px solid rgba(0,0,0,.06);background:#f8fbff;position:sticky;top:0;z-index:5}
    .locale-badge{background:#eef4ff;border:1px solid #dfe8ff;color:#163a8a;padding:6px 10px;border-radius:999px;font-weight:600}
    .spacer{flex:1}
    .views{display:contents}
    .view{padding:16px}
    .hidden{display:none}
    .muted{opacity:.7;color:var(--muted)}
    /* Home products area (left column) */
    .cats-wrap{position:sticky;top:72px;background:linear-gradient(90deg,rgba(255,255,255,.6),rgba(255,255,255,0));padding:8px 8px;border-radius:14px;margin-bottom:8px}
    .cats{display:flex;flex-wrap:wrap;gap:8px}
    .cat-chip{padding:10px 14px;border-radius:999px;border:1px solid #e3e8ff;background:#fff;cursor:pointer;font-weight:700}
    .cat-chip.active{background:#111;color:#fff;border-color:#111}
    .section-label{margin:12px 2px 8px;font-weight:800;text-transform:lowercase;letter-spacing:.4px;color:#1f2937}
    .products{display:grid;grid-template-columns:repeat(auto-fill,minmax(240px,1fr));gap:12px}
    .card{background:#fff;border:1px solid #eef2ff;border-radius:16px;padding:12px;display:flex;flex-direction:row;gap:10px;align-items:center;box-shadow:var(--shadow)}
    .card .img{width:48px;height:48px;border-radius:12px;border:1px solid #eef2ff;background:#fff;display:grid;place-items:center;overflow:hidden}
    .card .img img{width:100%;height:100%;object-fit:cover}
    .card .meta{flex:1;min-width:0}
    .card .meta .name{font-weight:700;white-space:nowrap;overflow:hidden;text-overflow:ellipsis}
    .card .price{font-weight:700}
    .card button{border:0;padding:8px 10px;border-radius:12px;background:#111;color:#fff;cursor:pointer;font-weight:700}
    /* Sale / Tavoli */
    .sale-tabs{display:flex;gap:8px;flex-wrap:wrap;margin-bottom:12px}
    .sale-tabs button{padding:8px 12px;border-radius:10px;border:1px solid #e3e8ff;background:#fff;font-weight:600;cursor:pointer}
    .sale-tabs button.active{background:#111;color:#fff;border-color:#111}
    .tavoli-grid{display:grid;grid-template-columns:repeat(auto-fill,minmax(220px,1fr));gap:12px}
    .tavolo-card{display:flex;gap:10px;align-items:center;padding:12px;border-radius:16px;border:1px solid #e2e8ff;background:linear-gradient(180deg,rgba(255,255,255,.9),rgba(255,255,255,.7));box-shadow:var(--shadow);cursor:pointer;transition:transform .08s ease}
    .tavolo-card:hover{transform:translateY(-1px)}
    .tavolo-badge{min-width:42px;height:42px;border-radius:12px;border:1px solid #e5e7f9;display:grid;place-items:center;font-weight:800;background:#fff}
    .tavolo-meta{flex:1}
    .tavolo-name{font-weight:800;margin:0}
    .tavolo-stato{font-weight:800}
    /* Right order panel */
    .order{position:sticky;top:72px;height:calc(100vh - 72px);display:flex;flex-direction:column;border-left:1px solid var(--ring);background:#fafcff}
    /* show only in Home */
    .order{display:none}
    body[data-view='home'] .order{display:flex}
    .order .head{padding:14px 14px 6px;display:flex;align-items:center;gap:8px}
    .order .head h3{margin:0;font-size:18px}
    .order .head .right{margin-left:auto;display:flex;gap:8px;align-items:center}
    .pill{font-size:13px;padding:6px 10px;border-radius:999px;background:#eef4ff;border:1px solid #dfe8ff;color:#163a8a;font-weight:700}
    .btn-add{border:0;padding:8px 12px;border-radius:12px;background:linear-gradient(180deg,var(--grad-a),var(--grad-b));color:#fff;font-weight:800;cursor:pointer;box-shadow:0 10px 24px rgba(0,0,0,.15)}
    .order .body{flex:1;overflow:auto;padding:10px 14px}
    .order .empty{color:var(--muted);margin:8px}
    .cart-item{display:grid;grid-template-columns:1fr auto auto;align-items:center;gap:10px;padding:10px;border:1px solid #eef2ff;background:#fff;border-radius:14px;margin-bottom:8px}
    .cart-item .tit{font-weight:700}
    .qty{display:flex;align-items:center;gap:6px}
    .qty button{width:28px;height:28px;border-radius:8px;border:1px solid #e5e7f9;background:#fff;cursor:pointer;font-weight:800}
    .cart-item .price{font-weight:800}
    .order .foot{border-top:1px solid var(--ring);padding:12px 14px;display:flex;flex-direction:column;gap:10px;background:#fff}
    .tot-row{display:flex;justify-content:space-between;font-weight:800}
    .btn-row{display:flex;gap:8px;flex-wrap:wrap}
    .btn{border:0;padding:10px 12px;border-radius:12px;background:linear-gradient(180deg,var(--grad-a),var(--grad-b));color:#fff;font-weight:800;cursor:pointer;box-shadow:0 10px 24px rgba(0,0,0,.15)}
    .btn.secondary{background:#eef2ff;color:#111;border:1px solid #dee3ff;box-shadow:none;font-weight:700}
    @media (max-width: 1080px){
      .main{grid-template-columns:1fr}
      .order{position:fixed;inset:auto 0 0 82px;height:auto;max-height:70vh;border-left:0;border-top:1px solid var(--ring);border-radius:14px 14px 0 0}
    }

    /* ===== Subtotale Modal ===== */
    .modal-sub-backdrop{
      position:fixed; inset:0; background:rgba(0,0,0,.45);
      display:none; align-items:center; justify-content:center; z-index:1000;
    }
    .modal-sub{
      width:min(720px,92vw); background:#fff; border-radius:24px; box-shadow:0 20px 60px rgba(0,0,0,.25);
      padding:20px;
    }
    .modal-title{
      text-align:center; font-weight:800; font-size:26px; margin:0 0 12px; color:#1e3a8a;
    }
    .sub-sum{
      display:grid; grid-template-columns:1fr 1fr 1fr; gap:12px; margin-bottom:12px;
    }
    .sub-box{
      border-radius:16px; padding:14px; background:linear-gradient(90deg, #c7f9e8, #cfe9ff);
      text-align:center; border:1px solid #e6f0ff;
    }
    .sub-box .lab{font-weight:700; color:#334155; opacity:.9;}
    .sub-box .val{font-weight:900; font-size:22px; color:#0b63f6;}
    .pct-row{
      display:flex; gap:10px; flex-wrap:wrap; margin:10px 0 14px;
    }
    .pct-btn{
      border:0; padding:10px 14px; border-radius:14px; background:#eaf4ff; font-weight:800; cursor:pointer;
      box-shadow:0 3px 10px rgba(0,0,0,.06);
    }
    .pad-grid{
      display:grid; grid-template-columns:repeat(3, 1fr); gap:12px;
    }
    .pad-grid .key{
      border:0; padding:16px 0; border-radius:14px; font-weight:900; font-size:18px; cursor:pointer; color:#fff;
      background:#0b63f6; box-shadow:0 6px 18px rgba(12,72,180,.25);
    }
    .key.clear{ background:#ff7b7b; color:#fff;}
    .confirm-bar{
      margin-top:16px; border-radius:16px; padding:14px; text-align:center; font-weight:900; font-size:18px; color:#fff;
      background:linear-gradient(90deg, #2ee6ab, #20b7f9); cursor:pointer; border:0;
    }
    .modal-close-x{
      position:absolute; top:10px; right:16px; border:0; background:transparent; font-size:22px; cursor:pointer;
      color:#64748b;
    }
  
    /* ===== Modal Pagamento (AGGIUNTA) ===== */
    .modal-pay-backdrop{position:fixed;inset:0;background:rgba(0,0,0,.45);display:none;align-items:center;justify-content:center;z-index:1100}
    .modal-pay{width:min(920px,95vw);background:#fff;border-radius:28px;box-shadow:0 24px 70px rgba(0,0,0,.3);padding:24px;position:relative}
    .pay-close{position:absolute;top:10px;right:16px;border:0;background:transparent;font-size:22px;color:#64748b;cursor:pointer}
    .pay-row{display:grid;grid-template-columns:1fr 1fr 1fr;gap:16px;margin:12px 0}
    .kpi{border-radius:16px;padding:14px;text-align:center;font-weight:800}
    .kpi.tot{background:#eef4ff}
    .kpi.paid{background:#e7fbef}
    .kpi.due{background:#ffe9ec}
    .segmented{display:grid;grid-template-columns:1fr 1fr;gap:16px;margin-bottom:12px}
    .segmented .seg{padding:12px 16px;border-radius:14px;border:1px solid #e6eefc;background:#f6fbff;font-weight:800;text-align:center;cursor:pointer}
    .segmented .seg.active{background:linear-gradient(90deg,#00c6ff,#0072ff);color:#fff;border:none}
    .tabs-pay{display:grid;grid-template-columns:repeat(4,1fr);gap:16px;margin:8px 0 12px}
    .tabs-pay button{padding:12px;border-radius:14px;border:1px solid #e6eefc;background:#f6fbff;font-weight:800;cursor:pointer}
    .tabs-pay button.active{background:linear-gradient(90deg,#00c6ff,#0072ff);color:#fff;border:none}
    .pay-methods{display:grid;grid-template-columns:1fr 1fr;gap:16px}
    .pay-card{background:#eef5ff;border:1px solid #e4edff;border-radius:16px;padding:24px;text-align:center;font-weight:800}
    .pay-footer{margin-top:16px;background:#eef5ff;border-radius:14px;padding:16px;text-align:center;font-weight:800}

  </style>
  <link rel="preconnect" href="https://fonts.googleapis.com">
  <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
  <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;600;700;800&display=swap" rel="stylesheet">
</head>
<body>
  <aside class="sidebar">
    <div class="brand">Zappy</div>
    <nav>
      <button class="nav-btn" data-view="home"><span class="icon">üè†</span></button>
      <button class="nav-btn" data-view="tavoli"><span class="icon">üìç</span></button>
      <button class="nav-btn" data-view="statistiche"><span class="icon">üìä</span></button>
    </nav>
  </aside>

  <main class="main">
    <header class="header">
      <div class="locale-badge"><span id="localeLabel">‚Äî</span></div>
      <div class="spacer"></div>
    </header>

    <div class="views">
      <!-- LEFT: HOME -->
      <section class="view" id="view-home">
        <div class="cats-wrap">
          <div id="cats"></div>
        </div>
        <div id="sections"></div>
      </section>

      <!-- LEFT: TAVOLI -->
      <section class="view hidden" id="view-tavoli">
        <h2>Tavoli</h2>
        <div id="saleTabs" class="sale-tabs"></div>
        <div id="tavoliGrid" class="tavoli-grid"></div>
        <p class="muted">Solo lettura da Firestore.</p>
      </section>

      <!-- LEFT: STATISTICHE -->
      <section class="view hidden" id="view-statistiche">
        <h2>Statistiche</h2>
        <p class="muted">Solo lettura (placeholder).</p>
      </section>
    </div>

    <!-- RIGHT: ORDER PANEL -->
    <aside class="order hidden" id="orderPane">
      <div class="head">
        <h3>Nuovo ordine</h3>
        <div class="right">
          <span class="pill" id="modeBadge">Vendita diretta</span>
          <button class="btn-add hidden" id="btnAddToTable">Aggiungi al tavolo</button>
          <button class="btn-add hidden" id="btnCancelTable">Annulla</button>
        </div>
      </div>
      <div class="body">
        <div class="empty" id="emptyCart">Nessun prodotto</div>
        <div id="cartList"></div>
      </div>
      <div class="foot">
        <div class="tot-row"><span>Totale:</span><span>‚Ç¨ <span id="totale">0,00</span></span></div>
        <div class="btn-row">
          <button class="btn secondary" id="btnSubtotale">Subtotale</button>
          <button class="btn secondary" id="btnPagamento">Pagamento</button>
          <button class="btn" id="btnPrepara">Prepara</button>
        </div>
      </div>
    </aside>
  </main>

  <!-- ===== MODAL SUBTOTALE ===== -->
  
  <!-- ===== MODAL PAGAMENTO (AGGIUNTA) ===== -->
  <div class="modal-pay-backdrop" id="payBackdrop" role="dialog" aria-modal="true" aria-labelledby="payTitle">
    <div class="modal-pay">
      <button class="pay-close" id="payClose" aria-label="Chiudi">‚úï</button>
      <h2 class="modal-title" id="payTitle">Pagamento</h2>

      <div class="segmented">
        <div class="seg active" data-type="persona">üë§ Persona</div>
        <div class="seg" data-type="azienda">üè¢ Azienda</div>
      </div>

      <div class="pay-row">
        <div class="kpi tot">
          Totale (‚Ç¨)<div style="font-size:22px" id="payTot">0,00</div>
        </div>
        <div class="kpi paid">
          Pagato (‚Ç¨)<div style="font-size:22px" id="payPaid">0,00</div>
        </div>
        <div class="kpi due">
          Da pagare (‚Ç¨)<div style="font-size:22px" id="payDue">0,00</div>
        </div>
      </div>

      <div class="tabs-pay">
        <button class="active" data-mode="totale">Totale</button>
        <button data-mode="parziale">Parziale</button>
        <button data-mode="romana">Alla Romana</button>
        <button data-mode="separata">Separata</button>
      </div>

      <div class="pay-methods">
        <div class="pay-card" id="btnCash">Contanti</div>
        <div class="pay-card" id="btnCard">Carte</div>
      </div>

      <div class="pay-footer" id="btnOther">Altro</div>
    </div>
  </div>


  <div class="modal-sub-backdrop" id="subBackdrop" role="dialog" aria-modal="true" aria-labelledby="subTitle">
    <div class="modal-sub" style="position:relative">
      <button class="modal-close-x" id="subCloseX" aria-label="Chiudi">‚úï</button>
      <h2 class="modal-title" id="subTitle">Subtotale ( ‚Ç¨ )</h2>
      <div class="sub-sum">
        <div class="sub-box">
          <div class="lab">Subtotale</div>
          <div class="val" id="subAmount">0,00</div>
        </div>
        <div class="sub-box">
          <div class="lab">Differenza</div>
          <div class="val" id="subDiff">0,00</div>
        </div>
        <div class="sub-box">
          <div class="lab">Totale</div>
          <div class="val" id="subFinal">0,00</div>
        </div>
      </div>

      <div class="pct-row">
        <button class="pct-btn" data-pct="-0.2">-20%</button>
        <button class="pct-btn" data-pct="-0.1">-10%</button>
        <button class="pct-btn" data-pct="-0.05">-5%</button>
        <button class="pct-btn" data-pct="0.05">+5%</button>
        <button class="pct-btn" data-pct="0.10">+10%</button>
        <button class="pct-btn" data-pct="0.20">+20%</button>
      </div>

      <div class="pad-grid">
        <button class="key">1</button>
        <button class="key">2</button>
        <button class="key">3</button>
        <button class="key">4</button>
        <button class="key">5</button>
        <button class="key">6</button>
        <button class="key">7</button>
        <button class="key">8</button>
        <button class="key">9</button>
        <button class="key">0</button>
        <button class="key">00</button>
        <button class="key clear">C</button>
      </div>

      <button class="confirm-bar" id="subConfirm">Conferma</button>
    </div>
  </div>

  <script type="module">
    import { initializeApp, getApps, getApp } from "https://www.gstatic.com/firebasejs/10.11.0/firebase-app.js";
    import { getFirestore, collection, getDocs, getDoc, doc } from "https://www.gstatic.com/firebasejs/10.11.0/firebase-firestore.js";

    // ---- CONFIG ----
    const firebaseConfig = {
      apiKey: "AIzaSyC-yyxd1dxn16hx9AUZDKgFpPLWl-YfWnHE",
      authDomain: "zappy-24d29.firebaseapp.com",
      projectId: "zappy-24d29",
      storageBucket: "zappy-24d29.appspot.com",
      messagingSenderId: "356775808247",
      appId: "1:356775808247:web:a5395430ad3dc9aa7c17f2"
    };
    const app = getApps().length ? getApp() : initializeApp(firebaseConfig);
    const db = getFirestore(app);

    // ---- UTIL ----
    const $ = (s,r=document)=>r.querySelector(s);
    const $$ = (s,r=document)=>Array.from(r.querySelectorAll(s));
    const LOCALE = new URLSearchParams(location.search).get("locale") || "zappydemo";
    $("#localeLabel").textContent = LOCALE;
    const money = n => (Number(n||0)).toFixed(2).replace('.',',');

    // ---- STATE ----
    let currentSala = null;
    let selectedTable = null;
    let cameFromTable = false;

    // ---- NAV ----
    function navTo(view){
      if (!view) view = 'home';
      if (location.hash !== '#' + view) {
        location.hash = '#' + view;
      } else {
        switchView(view);
      }
    }
    window.addEventListener('hashchange', () => {
      const v = (location.hash || '#home').replace('#','');
      switchView(v);
    });
    $$(".nav-btn").forEach(b=>b.onclick=()=>navTo(b.dataset.view));
    function switchView(v){
      document.body.dataset.view = v;
      $$(".view").forEach(x=>x.classList.add("hidden"));
      $("#view-"+v).classList.remove("hidden");
      if(v==="home") { loadHome(); showOrderPane(true); }
      if(v==="tavoli") { loadTavoli(); showOrderPane(false); }
      if(v==="statistiche") { showOrderPane(false); }
      updateHeaderButton();
    }

    // ---- CONTEXT ----
    function markCameFromTable(on){ cameFromTable = !!on; updateHeaderButton(); }
    function updateHeaderButton(){
      const btn = $("#btnAddToTable");
      const cancel = $("#btnCancelTable");
      const badge = $("#modeBadge");
      const inHome = !$("#view-home").classList.contains("hidden");
      const show = inHome && cameFromTable && !!selectedTable;
      btn.classList.toggle("hidden", !show);
      cancel.classList.toggle("hidden", !show);
      badge.textContent = show ? (selectedTable?.tavoloNome || "Tavolo") : "Vendita diretta";
      if(!btn._wired){
        btn._wired = true;
        btn.onclick = ()=>{ try{ carrello = []; renderCart(); }catch(e){} selectedTable = null; markCameFromTable(false); updateHeaderButton(); };
      }
      if(!cancel._wired){
        cancel._wired = true;
        cancel.onclick = ()=>{ try{ carrello = []; renderCart(); }catch(e){} selectedTable = null; markCameFromTable(false); updateHeaderButton(); };
      }
    }
    function showOrderPane(show){
      const pane = document.getElementById('orderPane');
      if (!pane) return;
      pane.classList.toggle('hidden', !show);
    }
    navTo((location.hash||"#home").replace("#",""));

    // ---- CARRELLO (UI only) ----
    let carrello = []; // {id, nome, prezzo, quantita}
    function renderCart(){
      const list = $("#cartList");
      const empty = $("#emptyCart");
      list.innerHTML = "";
      empty.style.display = carrello.length ? "none":"block";
      carrello.forEach((p, idx)=>{
        const row = document.createElement("div");
        row.className = "cart-item";
        row.innerHTML = `
          <div class="tit">${p.nome}</div>
          <div class="qty">
            <button data-act="dec">‚Äì</button>
            <span>${p.quantita}</span>
            <button data-act="inc">+</button>
          </div>
          <div class="price">‚Ç¨ ${money(p.prezzo * p.quantita)}</div>
        `;
        row.querySelector('[data-act="inc"]').onclick=()=>{ p.quantita++; renderCart(); };
        row.querySelector('[data-act="dec"]').onclick=()=>{ p.quantita--; if(p.quantita<=0){ carrello.splice(idx,1); } renderCart(); };
        list.appendChild(row);
      });
      const totale = carrello.reduce((s,p)=> s + (p.prezzo||0)*(p.quantita||1), 0);
      $("#totale").textContent = money(totale);
    }
    function addToCart(item){
      const i = carrello.findIndex(x=>x.id===item.id);
      if(i>=0) carrello[i].quantita += 1;
      else carrello.push({...item, quantita:1});
      renderCart();
      updateHeaderButton();
    }

    async function loadHome(){ await renderCategorieGruppi(); await renderSezioni(); }
    async function renderCategorieGruppi(){
      const wrap = $("#cats"); wrap.innerHTML="";
      const docRef = doc(db, "locali", LOCALE, "menu", "categorie");
      const snap = await getDoc(docRef).catch(()=>null);
      if(!snap || !snap.exists()){ wrap.innerHTML = "<span class='muted'>Nessuna categoria</span>"; return; }
      const data = snap.data();
      const groups = Object.keys(data);
      const row = document.createElement("div"); row.className="cats"; wrap.appendChild(row);
      groups.forEach(g=>{
        const arr = Array.isArray(data[g]) ? data[g] : [];
        arr.forEach(item=>{
          const key = item.originale || item.it || item.en;
          const label = item.it || item.en || key;
          const b = document.createElement("button");
          b.className = "cat-chip"; b.textContent = label;
          b.onclick = ()=> scrollToSection(key);
          row.appendChild(b);
        });
      });
    }
    async function renderSezioni(){
      const root = $("#sections"); root.innerHTML="";
      const docRef = doc(db, "locali", LOCALE, "menu", "categorie");
      const snap = await getDoc(docRef).catch(()=>null);
      if(!snap || !snap.exists()){ root.innerHTML = ""; return; }
      const data = snap.data();
      const allKeys = [];
      Object.keys(data).forEach(g => {
        (Array.isArray(data[g])?data[g]:[]).forEach(item => {
          const key = item.originale || item.it || item.en;
          const label = item.it || item.en || key;
          allKeys.push({key, label});
        });
      });

      for (const {key,label} of allKeys){
        const sec = document.createElement("div");
        sec.id = "sec-"+key;
        const title = document.createElement("div");
        title.className = "section-label";
        title.textContent = label.toLowerCase();
        sec.appendChild(title);

        const grid = document.createElement("div"); grid.className="products"; sec.appendChild(grid);
        const prodRef = collection(db, "locali", LOCALE, "menu", key, "prodotti");
        const snapP = await getDocs(prodRef).catch(()=>({docs:[]}));
        snapP.docs.forEach(d=>{
          const p = d.data();
          const card = document.createElement("div"); card.className="card";
          const imgHTML = p.immagineUrl ? `<img src="${p.immagineUrl}" alt="">` : "<span>üçî</span>";
          card.innerHTML = `
            <div class="img">${imgHTML}</div>
            <div class="meta">
              <div class="name">${(p.nome && (p.nome.it||p.nome.en||p.nome)) || d.id}</div>
            </div>
            <div class="price">‚Ç¨ ${(Number(p.prezzo)||0).toFixed(2)}</div>
            <button>Aggiungi</button>
          `;
          card.querySelector("button").onclick = ()=> addToCart({
            id: d.id, nome: (p.nome && (p.nome.it||p.nome.en||p.nome)) || d.id, prezzo: Number(p.prezzo)||0, categoria: key
          });
          grid.appendChild(card);
        });
        root.appendChild(sec);
      }
    }
    function scrollToSection(key){
      const el = document.getElementById("sec-"+key);
      if(!el) return;
      const top = el.getBoundingClientRect().top + window.scrollY - 90;
      window.scrollTo({top, behavior:"smooth"});
      $$(".cat-chip").forEach(x=>x.classList.remove("active"));
      const chip = Array.from(document.querySelectorAll(".cat-chip")).find(c => (c.textContent||'').toLowerCase() === (el.querySelector(".section-label").textContent||'').toLowerCase());
      if (chip) chip.classList.add("active");
    }

    async function loadTavoli(){
      $("#saleTabs").innerHTML=""; $("#tavoliGrid").innerHTML="";
      const saleSnap=await getDocs(collection(db,"locali",LOCALE,"sale")).catch(()=>({docs:[]}));
      const ids=saleSnap.docs.map(d=>d.id);
      if(!ids.length){ $("#saleTabs").innerHTML="<p class='muted'>Nessuna sala</p>"; return; }
      if(!currentSala) currentSala=ids[0];
      ids.forEach(id=>{
        const b=document.createElement("button"); b.textContent=id; if(id===currentSala)b.classList.add("active");
        b.onclick=()=>{currentSala=id; $$("#saleTabs button").forEach(x=>x.classList.remove("active")); b.classList.add("active"); renderTavoli(id);};
        $("#saleTabs").appendChild(b);
      });
      renderTavoli(currentSala);
    }
    async function renderTavoli(salaId){
      const grid=$("#tavoliGrid"); grid.innerHTML="";
      const snap=await getDocs(collection(db,"locali",LOCALE,"sale",salaId,"tavoli")).catch(()=>({docs:[]}));
      if(!snap.docs.length){ grid.innerHTML="<p>Nessun tavolo</p>"; return; }
      const parseNum = v => { const m=String(v||"").match(/\d+/); return m?parseInt(m[0],10):0; };
      snap.docs.slice().sort((a,b)=>parseNum(a.data().nome||a.id)-parseNum(b.data().nome||b.id)).forEach(docu=>{
        const d=docu.data();
        const occ=d?.stato==="occupato"||d?.occupato===true;
        const card=document.createElement("div");
        card.className="tavolo-card";
        card.innerHTML=`
          <div class="tavolo-badge">T</div>
          <div class="tavolo-meta">
            <p class="tavolo-name">${d?.nome||docu.id}</p>
            <div class="tavolo-stato" style="color:${occ?'#d63031':'#00b894'}">${occ?'Occupato':'Libero'}</div>
          </div>
        `;
        card.onclick=()=>{
          selectedTable = { salaId, tavoloId: docu.id, tavoloNome: d?.nome||docu.id };
          markCameFromTable(true);
          selectedTable = { salaId, tavoloId: docu.id, tavoloNome: d?.nome||docu.id };
          markCameFromTable(true);
          const t = document.getElementById('popupTavoloTitle');
          if(t) t.textContent = 'Tavolo ' + (d?.nome||docu.id);
          const tot = document.getElementById('popupTavoloTotale');
          if(tot) tot.textContent = '0,00 ‚Ç¨';
          const popup = document.getElementById('popupTavolo');
          if(popup) popup.style.display='flex';
        };
        grid.appendChild(card);
      });
    }

    // ===== Subtotale popup logic (UI only) =====
    const fmtEU = n => (Number(n)||0).toLocaleString('it-IT', {minimumFractionDigits:2, maximumFractionDigits:2});
    function cartTotal(){ return carrello.reduce((s,p)=> s + (p.prezzo||0)*(p.quantita||1), 0); }

    const subBackdrop = $("#subBackdrop");
    const subAmount = $("#subAmount");
    const subDiff = $("#subDiff");
    const subFinal = $("#subFinal");
    let subInput = "";  // stringa digitata
    let baseTot = 0;

    function openSub(){
      baseTot = cartTotal();
      subInput = "";
      subAmount.textContent = fmtEU(0);
      subDiff.textContent = fmtEU(0);
      subFinal.textContent = fmtEU(baseTot);
      subBackdrop.style.display = "flex";
    }
    function closeSub(){ subBackdrop.style.display = "none"; }

    function recompute(){
      const entered = Number(subInput.replace(',', '.')) || 0;
      subAmount.textContent = fmtEU(entered);
      const diff = entered - baseTot;
      subDiff.textContent = fmtEU(diff);
      subFinal.textContent = fmtEU(entered); // nel mock il totale coincide col subtotale scelto
    }

    // Bind buttons
    $("#btnSubtotale").onclick = openSub;
    $("#subConfirm").onclick = closeSub;
    $("#subCloseX").onclick = closeSub;
    subBackdrop.addEventListener('click', (e)=>{ if(e.target===subBackdrop) closeSub(); });

    $$(".key").forEach(k=>{
      k.addEventListener('click', ()=>{
        const t = k.textContent.trim();
        if(k.classList.contains('clear')){ subInput=""; }
        else { subInput += t; }
        recompute();
      });
    });
    $$(".pct-btn").forEach(b=>{
      b.addEventListener('click', ()=>{
        const pct = Number(b.dataset.pct);
        const val = baseTot * (1 + pct);
        subInput = String(Math.round(val*100)/100);
        recompute();
      });
    });

    // Buttons (placeholders for others)
    
    // ===== Pagamento modal (AGGIUNTA) =====
    const payBackdrop = $("#payBackdrop");
    function openPay(){
      const tot = cartTotal();
      $("#payTot").textContent = fmtEU(tot);
      const paid = 0;
      $("#payPaid").textContent = fmtEU(paid);
      $("#payDue").textContent = fmtEU(tot - paid);
      payBackdrop.style.display = "flex";
    }
    function closePay(){ payBackdrop.style.display = "none"; }

    $("#btnPagamento").onclick = openPay;
    $("#payClose").onclick = closePay;
    payBackdrop.addEventListener('click', (e)=>{ if(e.target===payBackdrop) closePay(); });

    $$(".segmented .seg").forEach(seg=>seg.addEventListener('click',()=>{
      $$(".segmented .seg").forEach(s=>s.classList.remove('active'));
      seg.classList.add('active');
    }));
    $$(".tabs-pay button").forEach(b=>b.addEventListener('click',()=>{
      $$(".tabs-pay button").forEach(x=>x.classList.remove('active'));
      b.classList.add('active');
    }));
    $("#btnCash").onclick=()=>alert("Contanti");
    $("#btnCard").onclick=()=>alert("Carte");
    $("#btnOther").onclick=()=>alert("Altro");
    
    $("#btnPrepara").onclick = ()=> alert("Prepara (solo UI).");

    // First render of cart
    renderCart();
  </script>

  <!-- ===== POPUP TAVOLO (REINSERITO) ===== -->
  <div id="popupTavolo" style="display:none;position:fixed;inset:0;z-index:100;background:rgba(0,0,0,.4);align-items:center;justify-content:center;">
    <div style="background:#fff;border-radius:12px;box-shadow:0 8px 24px rgba(0,0,0,.2);width:min(480px,90%);padding:16px;">
      <div style="display:flex;justify-content:space-between;align-items:center;margin-bottom:12px;">
        <h3 id="popupTavoloTitle" style="margin:0;font-size:18px;font-weight:700;">Tavolo</h3>
        <button id="popupTavoloClose" class="btn secondary">Chiudi</button>
      </div>
      <div id="popupTavoloContent" style="padding:8px 0;color:#555;">Nessun prodotto nel tavolo (tablet).</div>
      <div style="margin-top:12px;display:flex;justify-content:space-between;align-items:center;">
        <div style="font-weight:700;">Totale: <span id="popupTavoloTotale">0,00 ‚Ç¨</span></div>
        <div style="display:flex;gap:8px;">
          <button id="popupTavoloAdd" class="btn">Aggiungi prodotti</button>
          <button id="popupTavoloPay" class="btn">Vai al pagamento</button>
        </div>
      </div>
    </div>
  </div>


  <script>
  // === HANDLER POPUP TAVOLO (reinseriti) ===
  (function(){
    const $ = (s,r=document)=>r.querySelector(s);
    const pop = $('#popupTavolo');
    const btnClose = $('#popupTavoloClose');
    const btnAdd = $('#popupTavoloAdd');
    const btnPay = $('#popupTavoloPay');
    if(btnClose){
      btnClose.onclick = ()=>{
        if(pop) pop.style.display='none';
        try{ selectedTable = null; markCameFromTable(false); updateHeaderButton(); }catch(e){}
      };
    }
    if(btnAdd){
      btnAdd.onclick = ()=>{
        if(pop) pop.style.display='none';
        try { navTo('home'); } catch(e) { location.hash = '#home'; }
        try { markCameFromTable(true); updateHeaderButton(); } catch(e) {}
      };
    }
    if(btnPay){
      btnPay.onclick = ()=>{
        if(pop) pop.style.display='none';
        alert('Funzione pagamento da implementare');
      };
    }
  })();
  </script>

</body>
</html>
