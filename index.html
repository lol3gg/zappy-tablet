<!DOCTYPE html>
<html lang="it">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>Zappy – Read‑Only + Carrello</title>
  <style>
    :root{
      --grad-a:#00c6ff;
      --grad-b:#7d2ae8;
      --bg:#f2f7ff;
      --card:#ffffff;
      --muted:#6b7280;
      --ink:#0f172a;
      --ring:#e5e7f9;
      --shadow:0 10px 24px rgba(0,0,0,.06);
      --radius:16px;
    }
    *{box-sizing:border-box}html,body{height:100%}body{margin:0;background:var(--bg);font-family:Inter,system-ui,-apple-system,Segoe UI,Roboto}
    /* Left app sidebar */
    .sidebar {
      position: fixed;
      inset: 0 auto 0 0;
      width: 82px;
      background: linear-gradient(180deg, var(--grad-a) 0%, var(--grad-b) 100%);
      display: flex;
      flex-direction: column;
      align-items: center;
      justify-content: space-between; /* distribuzione uniforme */
      padding: 16px 10px;
    }
    .sidebar nav {
      display: flex;
      flex-direction: column;
      align-items: center;
      height: 100%;
      justify-content: space-between; /* primo in alto e ultimo in basso */
      padding: 40px 0; /* margine alto/basso */
    }
    .sidebar nav button:nth-child(2) {
      margin: auto 0; /* questo resta al centro verticale */
    }

    .brand{color:#fff;font-weight:700;margin:6px 0 12px}
    .nav-btn{width:56px;height:56px;border:0;border-radius:16px;background:radial-gradient(120% 120% at 20% 20%,rgba(255,255,255,.6),rgba(255,255,255,.15));box-shadow:0 10px 24px rgba(0,0,0,.15);cursor:pointer;display:grid;place-items:center;transition:transform .12s ease}
    .nav-btn:hover{transform:translateY(-2px)}.icon{font-size:22px}
    /* Main grid: content + order pane */
    .main{margin-left:82px;min-height:100vh;display:grid;grid-template-columns:1fr 360px}
    .header{grid-column:1/-1;height:56px;display:flex;align-items:center;padding:0 16px;border-bottom:1px solid rgba(0,0,0,.06);background:#f8fbff;position:sticky;top:0;z-index:5}
    .locale-badge{background:#eef4ff;border:1px solid #dfe8ff;color:#163a8a;padding:6px 10px;border-radius:999px;font-weight:600}
    .spacer{flex:1}
    .views{display:contents}
    .view{padding:16px}
    .hidden{display:none}
    .muted{opacity:.7;color:var(--muted)}
    /* Home products area (left column) */
    .cats-wrap{position:sticky;top:72px;background:linear-gradient(90deg,rgba(255,255,255,.6),rgba(255,255,255,0));padding:8px 8px;border-radius:14px;margin-bottom:8px}
    .cats{display:flex;flex-wrap:wrap;gap:8px}
    .cat-chip{padding:10px 14px;border-radius:999px;border:1px solid #e3e8ff;background:#fff;cursor:pointer;font-weight:700}
    .cat-chip.active{background:#111;color:#fff;border-color:#111}
    
.section-label{
  display: block !important;
  width: 305px !important;   /* larghezza fissa */
  color:#fff !important;
  font-weight:600 !important;
  padding: 8px 18px !important;
  margin: 20px 0 !important;  /* spazio sopra e sotto */
  border-radius: 14px !important;
  background: linear-gradient(
    to right,
    #39D9A9 0%,
    #00B4FF 30%,
    #6A00FF 60%,
    rgba(106,0,255,0.05) 80%,
    rgba(106,0,255,0) 100%
  ) !important;
}

    .products{display:grid;grid-template-columns:repeat(auto-fill,minmax(240px,1fr));gap:12px}
    .card{background:#fff;border:1px solid #eef2ff;border-radius:16px;padding:12px;display:flex;flex-direction:row;gap:10px;align-items:center;box-shadow:var(--shadow)}
    .card .img{width:48px;height:48px;border-radius:12px;border:1px solid #eef2ff;background:#fff;display:grid;place-items:center;overflow:hidden}
    .card .img img{width:100%;height:100%;object-fit:cover}
    .card .meta{flex:1;min-width:0}
    .card .meta .name{font-weight:700;white-space:nowrap;overflow:hidden;text-overflow:ellipsis}
    .card .price{font-weight:700}
    .card button{border:0;padding:8px 10px;border-radius:12px;background:#111;color:#fff;cursor:pointer;font-weight:700}
    /* Sale / Tavoli */
    .sale-tabs{display:flex;gap:8px;flex-wrap:wrap;margin-bottom:12px}
    .sale-tabs button{padding:8px 12px;border-radius:10px;border:1px solid #e3e8ff;background:#fff;font-weight:600;cursor:pointer}
    .sale-tabs button.active{background:#111;color:#fff;border-color:#111}
    .tavoli-grid{display:grid;grid-template-columns:repeat(auto-fill,minmax(220px,1fr));gap:12px}
    .tavolo-card{display:flex;gap:10px;align-items:center;padding:12px;border-radius:16px;border:1px solid #e2e8ff;background:linear-gradient(180deg,rgba(255,255,255,.9),rgba(255,255,255,.7));box-shadow:var(--shadow);cursor:pointer;transition:transform .08s ease}
    .tavolo-card:hover{transform:translateY(-1px)}
    .tavolo-badge{min-width:42px;height:42px;border-radius:12px;border:1px solid #e5e7f9;display:grid;place-items:center;font-weight:800;background:#fff}
    .tavolo-meta{flex:1}
    .tavolo-name{font-weight:800;margin:0}
    .tavolo-stato{font-weight:800}
    /* Right order panel */
    .order{position:sticky;top:72px;height:calc(100vh - 72px);display:flex;flex-direction:column;border-left:1px solid var(--ring);background:#fafcff}
    /* show only in Home */
    .order{display:none}
    body[data-view='home'] .order{display:flex}
    .order .head{padding:14px 14px 6px;display:flex;align-items:center;gap:8px}
    .order .head h3{margin:0;font-size:18px}
    .order .head .right{margin-left:auto;display:flex;gap:8px;align-items:center}
    .pill{font-size:13px;padding:6px 10px;border-radius:999px;background:#eef4ff;border:1px solid #dfe8ff;color:#163a8a;font-weight:700}
    .btn-add{border:0;padding:8px 12px;border-radius:12px;background:linear-gradient(180deg,var(--grad-a),var(--grad-b));color:#fff;font-weight:800;cursor:pointer;box-shadow:0 10px 24px rgba(0,0,0,.15)}
    .order .body{flex:1;overflow:auto;padding:10px 14px}
    .order .empty{color:var(--muted);margin:8px}
    .cart-item{display:grid;grid-template-columns:1fr auto auto;align-items:center;gap:10px;padding:10px;border:1px solid #eef2ff;background:#fff;border-radius:14px;margin-bottom:8px}
    .cart-item .tit{font-weight:700}
    .qty{display:flex;align-items:center;gap:6px}
    .qty button{width:28px;height:28px;border-radius:8px;border:1px solid #e5e7f9;background:#fff;cursor:pointer;font-weight:800}
    .cart-item .price{font-weight:800}
    .order .foot{border-top:1px solid var(--ring);padding:12px 14px;display:flex;flex-direction:column;gap:10px;background:#fff}
    .tot-row{display:flex;justify-content:space-between;font-weight:800}
    .btn-row{display:flex;gap:8px;flex-wrap:wrap}
    .btn{border:0;padding:10px 12px;border-radius:12px;background:linear-gradient(180deg,var(--grad-a),var(--grad-b));color:#fff;font-weight:800;cursor:pointer;box-shadow:0 10px 24px rgba(0,0,0,.15)}
    .btn.secondary{background:#eef2ff;color:#111;border:1px solid #dee3ff;box-shadow:none;font-weight:700}
    @media (max-width: 1080px){
      .main{grid-template-columns:1fr}
      .order{position:fixed;inset:auto 0 0 82px;height:auto;max-height:70vh;border-left:0;border-top:1px solid var(--ring);border-radius:14px 14px 0 0}
    }

    /* ===== Subtotale Modal ===== */
    .modal-sub-backdrop{
      position:fixed; inset:0; background:rgba(0,0,0,.45);
      display:none; align-items:center; justify-content:center; z-index:1000;
    }
    .modal-sub{
      width:min(720px,92vw); background:#fff; border-radius:24px; box-shadow:0 20px 60px rgba(0,0,0,.25);
      padding:20px;
    }
    .modal-title{
      text-align:center; font-weight:800; font-size:26px; margin:0 0 12px; color:#1e3a8a;
    }
    .sub-sum{
      display:grid; grid-template-columns:1fr 1fr 1fr; gap:12px; margin-bottom:12px;
    }
    .sub-box{
      border-radius:16px; padding:14px; background:linear-gradient(90deg, #c7f9e8, #cfe9ff);
      text-align:center; border:1px solid #e6f0ff;
    }
    .sub-box .lab{font-weight:700; color:#334155; opacity:.9;}
    .sub-box .val{font-weight:900; font-size:22px; color:#0b63f6;}
    .pct-row{
      display:flex; gap:10px; flex-wrap:wrap; margin:10px 0 14px;
    }
    .pct-btn{
      border:0; padding:10px 14px; border-radius:14px; background:#eaf4ff; font-weight:800; cursor:pointer;
      box-shadow:0 3px 10px rgba(0,0,0,.06);
    }
    .pad-grid{
      display:grid; grid-template-columns:repeat(3, 1fr); gap:12px;
    }
    .pad-grid .key{
      border:0; padding:16px 0; border-radius:14px; font-weight:900; font-size:18px; cursor:pointer; color:#fff;
      background:#0b63f6; box-shadow:0 6px 18px rgba(12,72,180,.25);
    }
    .key.clear{ background:#ff7b7b; color:#fff;}
    .confirm-bar{
      margin-top:16px; border-radius:16px; padding:14px; text-align:center; font-weight:900; font-size:18px; color:#fff;
      background:linear-gradient(90deg, #2ee6ab, #20b7f9); cursor:pointer; border:0;
    }
    .modal-close-x{
      position:absolute; top:10px; right:16px; border:0; background:transparent; font-size:22px; cursor:pointer;
      color:#64748b;
    }
  
    /* ===== Modal Pagamento (AGGIUNTA) ===== */
    .modal-pay-backdrop{position:fixed;inset:0;background:rgba(0,0,0,.45);display:none;align-items:center;justify-content:center;z-index:1100}
    .modal-pay{width:min(920px,95vw);background:#fff;border-radius:28px;box-shadow:0 24px 70px rgba(0,0,0,.3);padding:24px;position:relative}
    .pay-close{position:absolute;top:10px;right:16px;border:0;background:transparent;font-size:22px;color:#64748b;cursor:pointer}
    .pay-row{display:grid;grid-template-columns:1fr 1fr 1fr;gap:16px;margin:12px 0}
    .kpi{border-radius:16px;padding:14px;text-align:center;font-weight:800}
    .kpi.tot{background:#eef4ff}
    .kpi.paid{background:#e7fbef}
    .kpi.due{background:#ffe9ec}
    .segmented{display:grid;grid-template-columns:1fr 1fr;gap:16px;margin-bottom:12px}
    .segmented .seg{padding:12px 16px;border-radius:14px;border:1px solid #e6eefc;background:#f6fbff;font-weight:800;text-align:center;cursor:pointer}
    .segmented .seg.active{background:linear-gradient(90deg,#00c6ff,#0072ff);color:#fff;border:none}
    .tabs-pay{display:grid;grid-template-columns:repeat(4,1fr);gap:16px;margin:8px 0 12px}
    .tabs-pay button{padding:12px;border-radius:14px;border:1px solid #e6eefc;background:#f6fbff;font-weight:800;cursor:pointer}
    .tabs-pay button.active{background:linear-gradient(90deg,#00c6ff,#0072ff);color:#fff;border:none}
    .pay-methods{display:grid;grid-template-columns:1fr 1fr;gap:16px}
    .pay-card{background:#eef5ff;border:1px solid #e4edff;border-radius:16px;padding:24px;text-align:center;font-weight:800}
    .pay-footer{margin-top:16px;background:#eef5ff;border-radius:14px;padding:16px;text-align:center;font-weight:800}

  
/* ===== Miglioramento estetico sezione Tavoli ===== */
#view-tavoli h2 {
  text-align: center;
  font-size: 32px !important;
  font-weight: 900 !important;
  margin-top: 10px !important;
  margin-bottom: 24px !important;
  background: linear-gradient(90deg, #39D9A9, #00B4FF, #6A00FF);
  -webkit-background-clip: text;
  -webkit-text-fill-color: transparent;
}
  text-align: center;
  font-size: 26px;
  font-weight: 800;
  background: linear-gradient(90deg, #39D9A9, #00B4FF, #6A00FF);
  -webkit-background-clip: text;
  -webkit-text-fill-color: transparent;
  margin-bottom: 20px;
}

.tavolo-card {
  background: rgba(255, 255, 255, 0.6) !important;
  backdrop-filter: blur(8px);
  border: 1px solid rgba(255,255,255,0.3) !important;
  border-radius: 20px !important;
  padding: 16px !important;
  transition: all 0.2s ease !important;
}
.tavolo-card:hover {
  transform: scale(1.03) !important;
  box-shadow: 0 10px 24px rgba(0,0,0,0.15) !important;
}

.tavolo-badge {
  min-width: 54px !important;
  height: 54px !important;
  font-size: 18px !important;
  font-weight: 800 !important;
  color: #fff;
  background: linear-gradient(135deg, #39D9A9, #00B4FF);
  border: none !important;
}

.tavolo-meta {
  display: flex;
  flex-direction: column;
  gap: 4px;
}

.tavolo-name {
  font-size: 17px !important;
  font-weight: 700 !important;
}

.tavolo-stato {
  font-size: 15px !important;
  font-weight: 700 !important;
}
.tavolo-stato[style*="green"],
.tavolo-stato:contains("Libero") {
  color: #00c853 !important;
}
.tavolo-stato[style*="red"],
.tavolo-stato:contains("Occupato") {
  color: #d50000 !important;
}


.sale-tabs button{
  padding: 12px 18px !important;
  font-size: 16px !important;
  border-radius: 12px !important;
  font-weight: 700 !important;
}
.sale-tabs{
  justify-content: center !important;
}


/* ===== Tavoli più grandi del 20% ===== */
#view-tavoli h2 {
  font-size: 38px !important; /* +20% */
}

.sale-tabs button {
  padding: 14px 20px !important;
  font-size: 19px !important; /* +20% */
}

.tavolo-card {
  padding: 20px !important; /* +20% */
  border-radius: 22px !important;
}

.tavolo-badge {
  min-width: 65px !important; /* +20% */
  height: 65px !important;
  font-size: 22px !important;
}

.tavolo-name {
  font-size: 20px !important;
}

.tavolo-stato {
  font-size: 18px !important;
}


.settings-btn-wrap {
  margin-top: auto;
}
.sidebar {
  display: flex !important;
  flex-direction: column !important;
  justify-content: space-between !important;
}


.settings-card {
  background: #fff;
  border: 1px solid #e3e8ff;
  border-radius: 16px;
  padding: 16px;
  margin-top: 20px;
  box-shadow: 0 6px 18px rgba(0,0,0,0.08);
}
.settings-card h3 {
  margin-top: 0;
  font-size: 18px;
}
.settings-card p {
  margin: 6px 0 12px;
}


.wizard-step { display: none; }
.wizard-step.active { display: block; }
.wizard-step {
  background: #f8f9ff;
  border: 1px solid #e3e8ff;
  border-radius: 12px;
  padding: 20px;
  margin-top: 15px;
  box-shadow: 0 4px 12px rgba(0,0,0,0.05);
}
.wizard-step h4 { margin-top: 0; }
.input {
  display: block;
  width: 100%;
  padding: 8px;
  margin: 6px 0 14px;
  border: 1px solid #ccc;
  border-radius: 6px;
}


.wizard-progress {
  display: flex;
  align-items: center;
  justify-content: center;
  margin-bottom: 20px;
}
.step-dot {
  width: 28px;
  height: 28px;
  border-radius: 50%;
  background: #ccc;
  color: white;
  font-size: 14px;
  font-weight: bold;
  display: flex;
  align-items: center;
  justify-content: center;
  position: relative;
  z-index: 2;
}
.step-dot.active {
  background: #39d9a9;
}
.step-line {
  flex: 1;
  height: 4px;
  background: #ccc;
  margin: 0 6px;
  z-index: 1;
}
.step-dot.completed {
  background: #127a36;
}

</style>
  <link rel="preconnect" href="https://fonts.googleapis.com">
  <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
  <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;600;700;800&display=swap" rel="stylesheet">

  <!-- === THEME OVERRIDES: estetica da index2608ok.html (solo CSS) === -->
  <style id="theme-overrides">
    :root{
      --grad-a:#39D9A9;
      --grad-b:#00B4FF;
      --grad-c:#6A00FF;
      --card-azz:#e9f1fd;
      --card-br:rgba(57,217,169,0.4);
    }
    /* Sidebar gradient come index2608ok */
    .sidebar{
      background: linear-gradient(180deg, var(--grad-a), var(--grad-b), var(--grad-c)) !important;
    }
    /* Chips categoria con gradient */
    .cat-chip{
      background: linear-gradient(135deg, var(--grad-a), var(--grad-b), var(--grad-c)) !important;
      color:#fff !important;
      border:none !important;
      font-weight:600 !important;
    }
    .cat-chip:hover{ transform: translateY(-1px); }
    .cat-chip.active{
      filter: brightness(.92);
      box-shadow: 0 0 0 2px rgba(255,255,255,.4) inset;
    }

    /* Intestazioni sezione stile "barra gradiente" */
    
.section-label{
  display: block !important;
  width: 305px !important;   /* larghezza fissa */
  color:#fff !important;
  font-weight:600 !important;
  padding: 8px 18px !important;
  margin: 20px 0 !important;  /* spazio sopra e sotto */
  border-radius: 14px !important;
  background: linear-gradient(
    to right,
    #39D9A9 0%,
    #00B4FF 30%,
    #6A00FF 60%,
    rgba(106,0,255,0.05) 80%,
    rgba(106,0,255,0) 100%
  ) !important;
}


    /* Card prodotto azzurra con bordo acqua */
    .products{ gap:14px !important; }
    .card{
      background: var(--card-azz) !important;
      border: 1px solid var(--card-br) !important;
      border-radius:16px !important;
      box-shadow: 0 3px 6px rgba(0,0,0,0.05) !important;
      padding:10px !important;
      gap:10px !important;
    }
    .card:hover{ box-shadow: 0 4px 12px rgba(0,0,0,0.10) !important; transform: translateY(-2px); }
    .card .img{ width:50px !important; height:50px !important; border-radius:10px !important; }
    .card .meta .name{ font-weight:600 !important; color:#333 !important; }
    .card .price{ color:#444 !important; font-weight:600 !important; }
    .card button{ display:none !important; } /* il tuo layout non usa il bottone nelle card */

    /* Tavoli stile glassy più chiaro */
    .tavolo-card{
      background: linear-gradient(135deg, rgba(57,217,169,0.15), rgba(0,180,255,0.15)) !important;
      border: 1px solid rgba(255,255,255,0.3) !important;
      border-radius:18px !important;
      box-shadow: 0 8px 20px rgba(0,0,0,0.08) !important;
    }
    .tavolo-card:hover{ transform: translateY(-4px) !important; box-shadow: 0 12px 24px rgba(0,0,0,0.12) !important; }
    .tavolo-name{ font-weight:700 !important; color:#333 !important; }

    /* Pulsanti principali in gradient come nel file estetico */
    .btn, .btn-add{
      background: linear-gradient(135deg, var(--grad-a), var(--grad-b), var(--grad-c)) !important;
      color:#fff !important;
      border:none !important;
    }
    .btn.secondary{
      background:#eaf4ff !important;
      color:#111 !important;
      border: 1px solid #dbeafe !important;
      box-shadow:none !important;
    }
  </style>








<style id="zappy-medium-plus10-ui">
/* ===== ESTETICA MEDIUM +10% ===== */
.products{
  gap: 18px !important;
  grid-template-columns: repeat(auto-fill, minmax(280px, 1fr)) !important;
}
.card{
  padding: 16px !important;
  gap: 13px !important;
  border-radius: 17px !important;
}
.card .img{
  width: 78px !important;
  height: 78px !important;
  border-radius: 13px !important;
}
.card .meta .name{
  font-size: 17.5px !important;
  font-weight: 750 !important;
}
.card .price{
  font-size: 17.5px !important;
  font-weight: 750 !important;
}

/* Categorie e intestazioni */
.cat-chip{
  padding: 11px 17px !important;
  font-size: 15.5px !important;
}

.section-label{
  display: block !important;
  width: 305px !important;   /* larghezza fissa */
  color:#fff !important;
  font-weight:600 !important;
  padding: 8px 18px !important;
  margin: 20px 0 !important;  /* spazio sopra e sotto */
  border-radius: 14px !important;
  background: linear-gradient(
    to right,
    #39D9A9 0%,
    #00B4FF 30%,
    #6A00FF 60%,
    rgba(106,0,255,0.05) 80%,
    rgba(106,0,255,0) 100%
  ) !important;
}


/* Order/cart leggermente più grande */
.order .head h3{ font-size: 19.5px !important; }
.pill{ font-size: 14px !important; padding: 7px 11px !important; }
.cart-item{ padding: 11px !important; border-radius: 15px !important; }
.cart-item .tit{ font-size: 16.5px !important; }
.qty button{
  width: 28px !important; height: 28px !important;
  border-radius: 9px !important; font-size: 15.5px !important;
}
.cart-item .price{ font-size: 16.5px !important; }
.btn, .btn-add{
  padding: 11px 13px !important; border-radius: 13px !important; font-size: 15.5px !important;
}
.order .foot .tot-row{ font-size: 17.5px !important; }

/* Modal sottototale/pagamento */
.modal-title{ font-size: 24px !important; }
</style>

  <style id="click-to-cart-style">
    .card{ cursor: pointer !important; }
  </style>

<style id="cart-overrides">
/* === Cart: estetica card con immagine, prezzo e +/- verticali (override non invasivo) === */
.cart-item{
  display:grid !important;
  grid-template-columns:56px 1fr auto 62px !important;
  grid-template-areas:"thumb name price qty" !important;
  align-items:center !important; gap:12px !important;
  padding:12px !important; margin-bottom:10px !important;
  border:1px solid #eef2ff !important; background:#fff !important; border-radius:16px !important;
  box-shadow:0 6px 14px rgba(0,0,0,.04) !important;
}
.cart-thumb{grid-area:thumb; width:56px;height:56px;border-radius:16px;border:1px solid #e9eefb;
  overflow:hidden; display:grid;place-items:center; background:#f9fbff}
.cart-thumb img{width:100%;height:100%;object-fit:cover}
.cart-name{grid-area:name; font-weight:800; color:#111}
.cart-price{grid-area:price; font-weight:900; font-size:18px; color:#0f172a; margin-right:8px}
.cart-qtytext{display:block; font-weight:700; color:#2563eb; font-size:14px; margin-top:2px}
.qty-vertical{grid-area:qty; display:flex; flex-direction:column; gap:10px; align-items:center}
.btn-plus,.btn-minus{
  width:56px;height:56px;border:0;border-radius:18px;color:#fff;font-size:24px;font-weight:900;cursor:pointer;
  box-shadow:0 8px 18px rgba(0,0,0,.12)
}
.btn-plus{background:#2F7BFF}
.btn-minus{background:#FF5D5D}
.btn-plus:active,.btn-minus:active{transform:translateY(1px)}
</style>





<style id="tavoli-fullscreen-centering">
/* === SOLO PAGINA TAVOLI: tutto in alto, centrato orizzontalmente, inclusi i riquadri === */

body[data-view='tavoli'] .main{
  grid-template-columns: 1fr !important;
}

body[data-view='tavoli'] #view-tavoli{
  min-height: calc(100vh - 56px) !important;
  display: flex !important;
  flex-direction: column !important;
  justify-content: flex-start !important;   /* in alto */
  align-items: center !important;           /* centrato orizzontalmente */
  gap: 18px !important;
  padding-top: 20px !important;
  padding-bottom: 0 !important;
}

body[data-view='tavoli'] #view-tavoli h2{ margin-top: 0 !important; text-align:center !important; }
body[data-view='tavoli'] #view-tavoli .sale-tabs{ justify-content: center !important; }

/* Centrare la griglia dei tavoli */
body[data-view='tavoli'] #view-tavoli .tavoli-grid{
  display: flex !important;
  flex-wrap: wrap !important;
  justify-content: center !important;   /* centrati */
  gap: 18px !important;
  width: 100% !important;
  max-width: 1100px !important;
  margin: 0 auto !important;
}

body[data-view='tavoli'] #view-tavoli .muted{
  text-align: center !important;
  margin-top: 6px !important;
  margin-bottom: 0 !important;
}
</style>





  <!-- ===== OVERRIDE FINALE: no riquadro bianco + immagini non tagliate ===== -->
  <style id="product-thumb-final">
    .card .img{
      background: transparent !important;
      border: none !important;
    }
    .card .img img{
      width: 100% !important;
      height: 100% !important;
      object-fit: contain !important;   /* mostra tutta l’immagine */
      object-position: center center !important;
      background: transparent !important;
    }
  </style>


  <style id="product-thumb-fit">
    .card .img {
      width: 100px !important;
      height: 100px !important;
      display: flex !important;
      align-items: center !important;
      justify-content: center !important;
      background: transparent !important;
      border: none !important;
    }
    .card .img img {
      width: 100% !important;
      height: 100% !important;
      object-fit: contain !important;
      object-position: center center !important;
      margin: 0 auto !important;
      display: block !important;
    }
  </style>



<style id="card-selected-style">
  .card { position: relative !important; }
  .card.selected {
    background: rgba(0,0,0,0.06) !important;
    box-shadow: 0 0 0 2px #39D9A9 inset, 0 8px 18px rgba(0,0,0,.08) !important;
    transition: all 0.2s ease !important;
  }
  .card .qty-badge {
    position: absolute; top: 6px; right: 6px;
    background: #39D9A9; color: #fff; font-size: 13px; font-weight: 800;
    padding: 3px 7px; border-radius: 12px; display: none;
    box-shadow: 0 2px 8px rgba(0,0,0,.12);
  }
  .card .remove-btn {
    position: absolute; left: 50%; bottom: 10px; transform: translateX(-50%);
    background: #ff5d5d; color: #fff; border: 0; border-radius: 50%;
    width: 32px; height: 32px; font-weight: 900; font-size: 16px;
    line-height: 1; text-align: center; cursor: pointer; display: none;
    box-shadow: 0 6px 16px rgba(0,0,0,.15);
    display: none;
    /* centering */
    display: none;
  }
  /* Visualizza e centra perfettamente con flex quando selezionato */
  .card.selected .remove-btn {
    display: flex !important;
    align-items: center !important;
    justify-content: center !important;
  }
  .card.selected .qty-badge { display: block !important; }
</style>



  <!-- === OVERRIDE: rimuovi banner in alto e rendi categorie fisse === -->
  <style id="no-top-banner" disabled>
    .header{ display:none !important; }
    .cats-wrap{ 
        position: fixed !important;
        top: 0 !important;
        left: 0;
        right: 0;
        z-index: 1000;
    }
    body{
        padding-top:60px; /* spazio per non coprire i prodotti */
    }
  </style>

<style id='cats-fix'>
/* === FINAL FIX: barra categorie attaccata in alto === */
.cats-wrap{
  position: fixed !important;
  top: 0 !important;         /* parte dall’alto */
  left: 82px !important;     /* dopo la sidebar */
  right: 0 !important;
  z-index: 1000;
  background: #fff !important;
  border-bottom: 1px solid #ddd;
  padding: 14px 16px !important;
  box-shadow: 0 2px 6px rgba(0,0,0,0.08) !important;
}
.cat-chip{
  padding: 14px 20px !important;
  font-size: 18px !important;
  border-radius: 999px !important;
  font-weight: 700 !important;
}
body{
  padding-top: 90px !important;  /* lascia spazio sotto al banner */
  background: #fff !important;
}
</style>

<style id="section-label-final">
/* === Section label: 305px, sfumatura morbida, con spazio sopra/sotto === */
.section-label{
  display: block !important;
  width: 305px !important;             /* larghezza fissa richiesta */
  color:#fff !important;
  font-weight:600 !important;
  text-transform: lowercase !important;
  padding: 8px 18px !important;
  margin: 12px 0 14px 0 !important;    /* spazio sopra e sotto ripristinato */
  border-radius: 14px !important;
  background: linear-gradient(
    to right,
    #39D9A9 0%,
    #00B4FF 40%,
    #6A00FF 75%,
    rgba(106,0,255,0.08) 92%,
    rgba(106,0,255,0.0) 100%
  ) !important;
  box-shadow: none !important;
}
/* Disattiva eventuale pseudo-elemento precedente */
.section-label::after{ content:none !important; display:none !important; }
</style>


<style id="section-label-final-405">
/* === Section label: 405px, sfumatura molto morbida === */
.section-label{
  display: block !important;
  width: 405px !important;             /* larghezza fissa richiesta */
  color:#fff !important;
  font-weight:600 !important;
  text-transform: lowercase !important;
  padding: 8px 18px !important;
  margin: 12px 0 14px 0 !important;    /* spazio sopra e sotto */
  border-radius: 14px !important;
  background: linear-gradient(
    to right,
    #39D9A9 0%,
    #00B4FF 30%,
    #6A00FF 65%,
    rgba(106,0,255,0.12) 90%,
    rgba(106,0,255,0.0) 100%
  ) !important;
  box-shadow: none !important;
}
.section-label::after{ content:none !important; display:none !important; }
</style>


<style id="section-label-final-405fade">
/* === Section label: 405px, sfumatura morbida che inizia al 40% === */
.section-label{
  display: block !important;
  width: 405px !important;             /* larghezza fissa */
  color:#fff !important;
  font-weight:600 !important;
  text-transform: lowercase !important;
  padding: 8px 18px !important;
  margin: 12px 0 14px 0 !important;    /* spazio sopra e sotto */
  border-radius: 14px !important;
  background: linear-gradient(
    to right,
    #39D9A9 0%,           /* verde acqua */
    #00B4FF 20%,          /* azzurro */
    #6A00FF 40%,          /* viola - inizio dissolvenza */
    rgba(106,0,255,0.25) 65%,  /* più chiaro */
    rgba(106,0,255,0.08) 85%,  /* quasi trasparente */
    rgba(106,0,255,0.0) 100%   /* trasparente */
  ) !important;
  box-shadow: none !important;
}
.section-label::after{ content:none !important; display:none !important; }
</style>


<style id="section-label-final-405soft">
/* === Section label: 405px, sfumatura morbida dal 40%, colori più chiari === */
.section-label{
  display: block !important;
  width: 405px !important;
  color:#fff !important;
  font-weight:600 !important;
  text-transform: lowercase !important;
  padding: 8px 18px !important;
  margin: 12px 0 14px 0 !important;
  border-radius: 14px !important;
  background: linear-gradient(
    to right,
    rgba(57,217,169,0.85) 0%,   /* verde acqua più chiaro */
    rgba(0,180,255,0.75) 20%,   /* azzurro tenue */
    rgba(106,0,255,0.65) 40%,   /* viola meno forte - inizio dissolvenza */
    rgba(106,0,255,0.25) 65%,   /* in dissolvenza */
    rgba(106,0,255,0.08) 85%,   /* quasi trasparente */
    rgba(106,0,255,0.0) 100%    /* trasparente */
  ) !important;
  box-shadow: none !important;
}
.section-label::after{ content:none !important; display:none !important; }
</style>


<style id="sidebar-modern-stack">
/* Stacked, modern sidebar */
aside.sidebar nav{
  display:flex !important;
  flex-direction:column !important;
  align-items:center !important;
  justify-content:flex-start !important; /* all icons under the first */
  gap:14px !important;
  padding:16px 0 12px 0 !important;
  height:auto !important;
}
aside.sidebar .nav-btn{
  width:56px !important;
  height:56px !important;
  border-radius:18px !important;
  display:flex !important;
  align-items:center !important;
  justify-content:center !important;
  background: rgba(255,255,255,0.18) !important;
  backdrop-filter: blur(10px) !important;
  box-shadow: 0 10px 22px rgba(0,0,0,0.18), inset 0 1px 0 rgba(255,255,255,0.25) !important;
  border: none !important;
  outline: none !important;
  cursor: pointer !important;
  transition: transform .2s ease, background .2s ease, box-shadow .2s ease !important;
}
aside.sidebar .nav-btn:hover{
  transform: translateY(-2px) !important;
  background: rgba(255,255,255,0.26) !important;
  box-shadow: 0 14px 28px rgba(0,0,0,0.22), inset 0 1px 0 rgba(255,255,255,0.35) !important;
}
aside.sidebar .nav-btn.active{
  background: rgba(255,255,255,0.32) !important;
  box-shadow: 0 16px 30px rgba(0,0,0,0.25), inset 0 1px 0 rgba(255,255,255,0.45) !important;
}
/* SVG icon size + color aligned to palette */
aside.sidebar .nav-btn svg{
  width:26px !important;
  height:26px !important;
  display:block !important;
  filter: drop-shadow(0 1px 0 rgba(0,0,0,0.08));
}
/* Palette: acqua -> azzurro -> viola */
aside.sidebar .nav-btn svg .stroke{ stroke: #ffffff; stroke-opacity: 0.9; }
aside.sidebar .nav-btn svg .fill-1{ fill: #39D9A9; }
aside.sidebar .nav-btn svg .fill-2{ fill: #00B4FF; }
aside.sidebar .nav-btn svg .fill-3{ fill: #6A00FF; }
</style>


<style id="sidebar-top-left">
/* Sidebar: icone tutte in alto a sinistra sotto il brand */
.sidebar {
  display:flex !important;
  flex-direction:column !important;
  align-items:flex-start !important;
  justify-content:flex-start !important;
  padding: 16px 12px !important;
}
.sidebar .brand {
  margin-bottom: 14px !important;
}
.sidebar nav {
  display: flex !important;
  flex-direction: column !important;
  align-items: flex-start !important;
  justify-content: flex-start !important;
  gap: 12px !important;
  margin-top: 4px !important;
  height: auto !important;
}
.sidebar .nav-btn {
  margin: 0 !important;
}
</style>


<style id="sidebar-visible">
/* Sidebar buttons ben visibili */
.sidebar .nav-btn {
  width: 56px !important;
  height: 56px !important;
  border-radius: 18px !important;
  display: flex !important;
  align-items: center !important;
  justify-content: center !important;
  background: rgba(255,255,255,0.35) !important; /* più chiaro per staccare */
  border: 1px solid rgba(255,255,255,0.55) !important; /* bordo più evidente */
  backdrop-filter: blur(14px) !important;
  box-shadow: 0 6px 16px rgba(0,0,0,0.18) !important;
  transition: all 0.25s ease !important;
  cursor: pointer !important;
}
.sidebar .nav-btn:hover {
  background: rgba(255,255,255,0.5) !important;
  box-shadow: 0 0 14px rgba(57,217,169,0.6), 0 8px 20px rgba(0,0,0,0.25) !important;
  transform: translateY(-2px) !important;
}
.sidebar .nav-btn svg {
  width: 26px !important;
  height: 26px !important;
  filter: drop-shadow(0 1px 1px rgba(0,0,0,0.25));
}
</style>


<style id="sidebar-contrast-boost">
/* Boost visibilità icone sidebar */
.sidebar .nav-btn{
  width: 58px !important;
  height: 58px !important;
  border-radius: 18px !important;
  display: flex !important;
  align-items: center !important;
  justify-content: center !important;
  background: rgba(255,255,255,0.42) !important;          /* più chiaro */
  border: 1.5px solid rgba(255,255,255,0.70) !important;   /* bordo più evidente */
  backdrop-filter: blur(14px) !important;
  -webkit-backdrop-filter: blur(14px) !important;
  box-shadow: 0 10px 24px rgba(0,0,0,0.22), 0 2px 0 rgba(255,255,255,0.6) inset !important;
  transition: all .2s ease !important;
}
.sidebar .nav-btn:hover{
  background: rgba(255,255,255,0.52) !important;
  box-shadow: 0 0 14px rgba(57,217,169,0.55), 0 14px 28px rgba(0,0,0,0.25) !important;
  transform: translateY(-2px) !important;
}
/* Icone più leggibili */
.sidebar .nav-btn svg{
  width: 28px !important;
  height: 28px !important;
  filter: drop-shadow(0 1px 0 rgba(0,0,0,0.12));
}
.sidebar .nav-btn svg .stroke{ stroke: #ffffff !important; stroke-width: 2 !important; stroke-opacity: 0.95 !important; }
.sidebar .nav-btn svg .fill-1{ fill:#24C08F !important; }  /* verde più saturo */
.sidebar .nav-btn svg .fill-2{ fill:#17A8FF !important; }  /* azzurro più saturo */
.sidebar .nav-btn svg .fill-3{ fill:#6A00FF !important; }  /* viola brand */
</style>


<style id="stats-css">
#view-statistiche { padding: 18px 20px; }
#view-statistiche .stats-header { display:flex; align-items:center; justify-content:space-between; gap:16px; margin-bottom:14px; }
#view-statistiche .filters { display:flex; align-items:center; gap:10px; flex-wrap:wrap; }
#view-statistiche .filters label { display:flex; align-items:center; gap:6px; font-weight:600; }
#view-statistiche .filters select, 
#view-statistiche .filters input, 
#view-statistiche .filters .btn{
  padding:8px 10px; border-radius:10px; border:1px solid #e5edf2; background:#fff;
  box-shadow: 0 6px 16px rgba(0,0,0,0.06);
}
#view-statistiche .filters .btn{ background:#39D9A9; color:#fff; border:0; cursor:pointer; }
#view-statistiche .filters .btn:hover{ filter:brightness(1.05); }

.stats-cards{
  display:grid; grid-template-columns: repeat(6, minmax(140px,1fr));
  gap:12px; margin-bottom:18px;
}
.stat-card{
  background: rgba(255,255,255,0.85);
  backdrop-filter: blur(6px);
  border:1px solid #e6f2ef;
  border-radius:16px; padding:12px 14px;
  box-shadow: 0 10px 18px rgba(0,0,0,0.06);
}
.stat-card .stat-label{ font-size:12px; opacity:.7; margin-bottom:8px; }
.stat-card .stat-value{ font-size:22px; font-weight:800; color:#17212b; }
.stat-card .stat-value.sm{ font-size:18px; }

.stats-charts{ display:grid; grid-template-columns: repeat(2, 1fr); gap:16px; }
.chart-box{ background:#fff; border:1px solid #e9eef3; border-radius:16px; padding:12px; box-shadow: 0 10px 18px rgba(0,0,0,0.05); }

.stats-tables{ display:grid; grid-template-columns: 1fr 1fr; gap:16px; margin-top:16px; }
.table-box{ background:#fff; border:1px solid #e9eef3; border-radius:16px; padding:12px; box-shadow: 0 10px 18px rgba(0,0,0,0.05); }
.table-box table{ width:100%; border-collapse:separate; border-spacing:0 8px; }
.table-box th{ text-align:left; font-size:12px; opacity:.7; padding:0 8px; }
.table-box td{ background:#f8fbfd; border:1px solid #e6eef4; padding:8px; border-radius:8px; }
.hidden{ display:none; }
@media(max-width:1100px){
  .stats-cards{ grid-template-columns: repeat(3, 1fr); }
  .stats-charts{ grid-template-columns: 1fr; }
  .stats-tables{ grid-template-columns: 1fr; }
}
</style>


<style id="pay-tablet-style">
#payDynamic { margin: 10px 0; }
#payDynamic .muted{ opacity:0.7; margin-bottom:6px; }
.pay-sep-row{
  display: grid;
  grid-template-columns: 1fr auto 36px;
  align-items: center;
  gap: 12px;
  padding: 12px;
  border-radius: 12px;
  font-size: 18px;
}
.pay-sep-row.selected{ background: rgba(57,217,169,0.15); }
.pay-sep-check{ width: 30px; height: 30px; accent-color:#39D9A9; }
</style>


<style id="pay-romana-style">
#payDynamic .romana-wrapper{
  display:flex;
  justify-content:center;
  align-items:center;
  gap:10px;
  margin: 10px 0;
  font-size:22px;
  font-weight:600;
}
#payDynamic #romanaPeople{
  font-size:22px;
  padding:6px 10px;
  width:80px;
  border-radius:8px;
  border:2px solid #39D9A9;
  text-align:center;
}
#payDynamic #romanaQuota{
  margin-top:10px;
  font-size:24px;
  font-weight:700;
}
</style>

</head>
<body>
  <aside class="sidebar">
    <div class="brand">Zappy</div>
    <nav>
      <button class="nav-btn" data-view="home">
<svg viewBox="0 0 24 24" aria-hidden="true">
  <path class="fill-1" d="M3 11.5 12 4l9 7.5v7a2 2 0 0 1-2 2h-4.5v-6h-5v6H5a2 2 0 0 1-2-2v-7Z"/>
  <path class="stroke" d="M3 11.5 12 4l9 7.5" fill="none" stroke-width="1.5" stroke-linecap="round" stroke-linejoin="round"/>
</svg>
</button>
      <button class="nav-btn" data-view="tavoli">
<svg viewBox="0 0 24 24" aria-hidden="true">
  <path class="stroke" d="M12 22s6-5.5 6-11a6 6 0 1 0-12 0c0 5.5 6 11 6 11Z" fill="none" stroke-width="1.5" stroke-linecap="round" stroke-linejoin="round"/>
  <circle class="fill-2" cx="12" cy="11" r="3.2"/>
</svg>
</button>
      <button class="nav-btn" data-view="statistiche">
<svg viewBox="0 0 24 24" aria-hidden="true">
  <rect class="fill-1" x="3" y="11.5" width="4" height="8" rx="1.2"/>
  <rect class="fill-2" x="10" y="7" width="4" height="12.5" rx="1.2"/>
  <rect class="fill-3" x="17" y="4" width="4" height="15.5" rx="1.2"/>
</svg>
</button>

    </nav>
  
  

  <!-- Bottone impostazioni in basso (SIDEBAR) -->
  <div class="settings-btn-wrap">
    <button class="nav-btn" data-view="impostazioni" title="Impostazioni">
      <svg viewBox="0 0 24 24" aria-hidden="true">
        <path class="stroke" d="M10.3 2h3.4l.7 2.2c.2.6.8 1 1.4 1.1l2.3.3c.6.1 1.1.5 1.3 1.1l1.1 2-1.7 1.7c-.4.4-.5 1-.3 1.5l.6 2.3c.2.6 0 1.2-.5 1.6l-2 1.1c-.5.3-1.1.3-1.6 0l-1.9-1.1a1.6 1.6 0 0 0-1.6 0l-1.9 1.1c-.5.3-1.1.3-1.6 0l-2-1.1a1.6 1.6 0 0 1-.5-1.6l.6-2.3c.1-.5 0-1.1-.3-1.5L3.5 8.7l1.1-2c.3-.5.8-1 1.3-1.1l2.3-.3c.6-.1 1.1-.5 1.4-1.1L10.3 2z"/>
        <circle class="fill-2" cx="12" cy="12" r="3"/>
      </svg>
    </button>
  </div>

</aside>


  <main class="main">
    <header class="header">
      <div class="locale-badge"><span id="localeLabel">—</span></div>
      <div class="spacer"></div>
    </header>

    <div class="views">
      <!-- LEFT: HOME -->
      <section class="view" id="view-home">
        <div class="cats-wrap">
          <div id="cats"></div>
        </div>
        <div id="sections"></div>
      </section>

      <!-- LEFT: TAVOLI -->
      <section class="view hidden" id="view-tavoli">
        <h2>Tavoli</h2>
        <div id="saleTabs" class="sale-tabs"></div>
        <div id="tavoliGrid" class="tavoli-grid"></div>
        <p class="muted">Solo lettura da Firestore.</p>
      </section>

      <!-- LEFT: STATISTICHE -->
      
<section class="view hidden" id="view-statistiche">
  <div class="stats-header">
    <h2>Statistiche</h2>
    <div class="filters">
      <label>Periodo
        <select id="stats-range">
          <option value="7">Ultimi 7 giorni</option>
          <option value="30" selected>Ultimi 30 giorni</option>
          <option value="90">Ultimi 90 giorni</option>
          <option value="custom">Personalizzato</option>
        </select>
      </label>
      <input type="date" id="stats-from" class="hidden">
      <input type="date" id="stats-to" class="hidden">
      <label>Categoria
        <select id="stats-category">
          <option value="all" selected>Tutte</option>
          <option value="drink">Drink</option>
          <option value="birra">Birra</option>
          <option value="vino">Vino</option>
          <option value="analcoliche">Analcoliche</option>
          <option value="panini">Panini</option>
          <option value="fritti">Fritti</option>
          <option value="pizze">Pizze</option>
        </select>
      </label>
      <button id="stats-refresh" class="btn">Aggiorna</button>
    </div>
  </div>

  <div class="stats-cards">
    <div class="stat-card">
      <div class="stat-label">Guadagno totale</div>
      <div class="stat-value" id="totalRevenue">€0,00</div>
    </div>
    <div class="stat-card">
      <div class="stat-label">Ordini totali</div>
      <div class="stat-value" id="totalOrders">0</div>
    </div>
    <div class="stat-card">
      <div class="stat-label">Scontrino medio</div>
      <div class="stat-value" id="avgTicket">€0,00</div>
    </div>
    <div class="stat-card">
      <div class="stat-label">Prodotto top</div>
      <div class="stat-value sm" id="bestProduct">–</div>
    </div>
    <div class="stat-card">
      <div class="stat-label">Prodotto flop</div>
      <div class="stat-value sm" id="worstProduct">–</div>
    </div>
    <div class="stat-card">
      <div class="stat-label">Orario di punta</div>
      <div class="stat-value sm" id="peakHour">–</div>
    </div>
  </div>

  <div class="stats-charts">
    <div class="chart-box"><canvas id="chartRevenueOverTime"></canvas></div>
    <div class="chart-box"><canvas id="chartTopProducts"></canvas></div>
    <div class="chart-box"><canvas id="chartByCategory"></canvas></div>
    <div class="chart-box"><canvas id="chartOrdersByHour"></canvas></div>
  </div>

  <div class="stats-tables">
    <div class="table-box">
      <h3>Top 15 prodotti</h3>
      <table id="tableTopProducts">
        <thead><tr><th>#</th><th>Prodotto</th><th>Q.tà</th><th>Incasso</th></tr></thead>
        <tbody></tbody>
      </table>
    </div>
    <div class="table-box">
      <h3>Prodotti meno venduti</h3>
      <table id="tableWorstProducts">
        <thead><tr><th>#</th><th>Prodotto</th><th>Q.tà</th><th>Incasso</th></tr></thead>
        <tbody></tbody>
      </table>
    </div>
  </div>
</section>
      <!-- LEFT: IMPOSTAZIONI -->
      <section class="view hidden" id="view-impostazioni">
        <h2>Impostazioni</h2>
        <p class="muted">Qui potrai gestire le impostazioni del locale.</p>
  <div class="settings-card">
    <h3>Onboarding Stripe Connect</h3>
    
    <div id="wizardProgress" class="wizard-progress">
      <div class="step-dot active" data-step="1">1</div>
      <div class="step-line"></div>
      <div class="step-dot" data-step="2">2</div>
      <div class="step-line"></div>
      <div class="step-dot" data-step="3">3</div>
      <div class="step-line"></div>
      <div class="step-dot" data-step="4">4</div>
    </div>

    <div id="stripeWizard">
      <!-- Step 1: Tipo account -->
      <div class="wizard-step active" data-step="1">
        <h4>Tipo di account</h4>
        <p>Seleziona il tipo di account da collegare:</p>
        <select id="accountType" class="input">
          <option value="">-- Seleziona --</option>
          <option value="individual">Personale / Impresa Individuale</option>
          <option value="company">Azienda</option>
          <option value="nonprofit">Associazione (APS / ONLUS / ASD)</option>
        </select>
        <button class="btn next-step">Avanti</button>
      </div>

      <!-- Step 2: Dati personali -->
      <div class="wizard-step" data-step="2">
        <h4>Dati personali</h4>
        <label>Nome</label>
        <input type="text" id="firstName" class="input" placeholder="Mario">
        <label>Cognome</label>
        <input type="text" id="lastName" class="input" placeholder="Rossi">
        <label>Email</label>
        <input type="email" id="email" class="input" placeholder="esempio@mail.com">
        <label>Data di nascita</label>
        <input type="date" id="dob" class="input">
        <label>Indirizzo</label>
        <input type="text" id="address" class="input" placeholder="Via Roma, 10">
        <label>Codice postale</label>
        <input type="text" id="postal" class="input" placeholder="00100">
        <label>Città</label>
        <input type="text" id="city" class="input" placeholder="Roma">
        <label>Provincia</label>
        <input type="text" id="province" class="input" placeholder="RM">
        <label>Telefono</label>
        <input type="tel" id="phone" class="input" placeholder="+39 333 1234567">
        <button class="btn prev-step secondary">Indietro</button>
        <button class="btn next-step">Avanti</button>
      </div>

      <!-- Step 3: Coordinate bancarie -->
      <div class="wizard-step" data-step="3">
        <h4>Coordinate bancarie</h4>
        <label>Valuta</label>
        <select id="currency" class="input">
          <option value="EUR">EUR - Euro</option>
          <option value="USD">USD - Dollaro</option>
        </select>
        <label>Paese del conto bancario</label>
        <input type="text" id="bankCountry" class="input" value="Italy">
        <label>IBAN</label>
        <input type="text" id="iban" class="input" placeholder="IT60X0542811101000000123456">
        <label>Conferma IBAN</label>
        <input type="text" id="ibanConfirm" class="input" placeholder="Ripeti IBAN">
        <button class="btn prev-step secondary">Indietro</button>
        <button class="btn next-step">Avanti</button>
      </div>

      <!-- Step 4: Conferma -->
      <div class="wizard-step" data-step="4">
        <h4>Conferma ✅</h4>
        <p>Hai inserito i seguenti dati:</p>
        <ul>
          <li><b>Tipo account:</b> <span id="confirmAccountType"></span></li>
          <li><b>Nome:</b> <span id="confirmFirstName"></span></li>
          <li><b>Cognome:</b> <span id="confirmLastName"></span></li>
          <li><b>Email:</b> <span id="confirmEmail"></span></li>
          <li><b>Data di nascita:</b> <span id="confirmDob"></span></li>
          <li><b>Indirizzo:</b> <span id="confirmAddress"></span>, <span id="confirmPostal"></span> <span id="confirmCity"></span> (<span id="confirmProvince"></span>)</li>
          <li><b>Telefono:</b> <span id="confirmPhone"></span></li>
          <li><b>Valuta:</b> <span id="confirmCurrency"></span></li>
          <li><b>Paese conto:</b> <span id="confirmBankCountry"></span></li>
          <li><b>IBAN:</b> <span id="confirmIBAN"></span></li>
        </ul>
        <button class="btn prev-step secondary">Indietro</button>
      </div>
    </div>
  </div>
    <button id="btnDisconnectStripe" class="btn secondary hidden">Disconnetti</button>
  </div>

      </section>


    </div>

    <!-- RIGHT: ORDER PANEL -->
    <aside class="order hidden" id="orderPane">
      <div class="head">
        <h3>Nuovo ordine</h3>
        <div class="right">
          <span class="pill" id="modeBadge">Vendita diretta</span>
          <button class="btn-add hidden" id="btnAddToTable">Aggiungi al tavolo</button>
          <button class="btn-add hidden" id="btnCancelTable">Annulla</button>
        </div>
      </div>
      <div class="body">
        <div class="empty" id="emptyCart">Nessun prodotto</div>
        <div id="cartList"></div>
      </div>
      <div class="foot">
        <div class="tot-row"><span>Totale:</span><span>€ <span id="totale">0,00</span></span></div>
        <div class="btn-row">
          <button class="btn secondary" id="btnSubtotale">Subtotale</button>
          <button class="btn secondary" id="btnPagamento">Pagamento</button>
          <button class="btn" id="btnPrepara">Prepara</button>
        </div>
      </div>
    
  </aside>

  </main>

  <!-- ===== MODAL SUBTOTALE ===== -->
  
  <!-- ===== MODAL PAGAMENTO (AGGIUNTA) ===== -->
  <div class="modal-pay-backdrop" id="payBackdrop" role="dialog" aria-modal="true" aria-labelledby="payTitle">
    <div class="modal-pay">
      <button class="pay-close" id="payClose" aria-label="Chiudi">✕</button>
      <h2 class="modal-title" id="payTitle">Pagamento</h2>

      <div class="segmented">
        <div class="seg active" data-type="persona">👤 Persona</div>
        <div class="seg" data-type="azienda">🏢 Azienda</div>
      </div>

      <div class="pay-row">
        <div class="kpi tot">
          Totale (€)<div style="font-size:22px" id="payTot">0,00</div>
        </div>
        <div class="kpi paid">
          Pagato (€)<div style="font-size:22px" id="payPaid">0,00</div>
        </div>
        <div class="kpi due">
          Da pagare (€)<div style="font-size:22px" id="payDue">0,00</div>
        </div>
      </div>

      <div class="tabs-pay">
        <button class="active" data-mode="totale">Totale</button>
        <button data-mode="parziale">Parziale</button>
        <button data-mode="romana">Alla Romana</button>
        <button data-mode="separata">Separata</button>
      </div>

      <div id="payDynamic"></div>
      <div class="pay-methods">
        <div class="pay-card" id="btnCash">Contanti</div>
        <div class="pay-card" id="btnCard">Carte</div>
      </div>

      <div class="pay-footer" id="btnOther">Altro</div>
    </div>
  </div>


  <div class="modal-sub-backdrop" id="subBackdrop" role="dialog" aria-modal="true" aria-labelledby="subTitle">
    <div class="modal-sub" style="position:relative">
      <button class="modal-close-x" id="subCloseX" aria-label="Chiudi">✕</button>
      <h2 class="modal-title" id="subTitle">Subtotale ( € )</h2>
      <div class="sub-sum">
        <div class="sub-box">
          <div class="lab">Subtotale</div>
          <div class="val" id="subAmount">0,00</div>
        </div>
        <div class="sub-box">
          <div class="lab">Differenza</div>
          <div class="val" id="subDiff">0,00</div>
        </div>
        <div class="sub-box">
          <div class="lab">Totale</div>
          <div class="val" id="subFinal">0,00</div>
        </div>
      </div>

      <div class="pct-row">
        <button class="pct-btn" data-pct="-0.2">-20%</button>
        <button class="pct-btn" data-pct="-0.1">-10%</button>
        <button class="pct-btn" data-pct="-0.05">-5%</button>
        <button class="pct-btn" data-pct="0.05">+5%</button>
        <button class="pct-btn" data-pct="0.10">+10%</button>
        <button class="pct-btn" data-pct="0.20">+20%</button>
      </div>

      <div class="pad-grid">
        <button class="key">1</button>
        <button class="key">2</button>
        <button class="key">3</button>
        <button class="key">4</button>
        <button class="key">5</button>
        <button class="key">6</button>
        <button class="key">7</button>
        <button class="key">8</button>
        <button class="key">9</button>
        <button class="key">0</button>
        <button class="key">00</button>
        <button class="key clear">C</button>
      </div>

      <button class="confirm-bar" id="subConfirm">Conferma</button>
    </div>
  </div>

  <script type="module">
    import { initializeApp, getApps, getApp } from "https://www.gstatic.com/firebasejs/10.11.0/firebase-app.js";
    import { getFirestore, collection, getDocs, getDoc, doc } from "https://www.gstatic.com/firebasejs/10.11.0/firebase-firestore.js";

    // ---- CONFIG ----
    const firebaseConfig = {
      apiKey: "AIzaSyC-yyxd1dxn16hx9AUZDKgFpPLWl-YfWnHE",
      authDomain: "zappy-24d29.firebaseapp.com",
      projectId: "zappy-24d29",
      storageBucket: "zappy-24d29.appspot.com",
      messagingSenderId: "356775808247",
      appId: "1:356775808247:web:a5395430ad3dc9aa7c17f2"
    };
    const app = getApps().length ? getApp() : initializeApp(firebaseConfig);
    const db = getFirestore(app);

    // ---- UTIL ----
    const $ = (s,r=document)=>r.querySelector(s);
    const $$ = (s,r=document)=>Array.from(r.querySelectorAll(s));
    const LOCALE = new URLSearchParams(location.search).get("locale") || "zappydemo";
    $("#localeLabel").textContent = LOCALE;
    const money = n => (Number(n||0)).toFixed(2).replace('.',',');

    // ---- STATE ----
    let currentSala = null;
    let selectedTable = null;
    let cameFromTable = false;

    // ---- NAV ----
    function navTo(view){
      if (!view) view = 'home';
      if (location.hash !== '#' + view) {
        location.hash = '#' + view;
      } else {
        switchView(view);
      }
    }
    window.addEventListener('hashchange', () => {
      const v = (location.hash || '#home').replace('#','');
      switchView(v);
    });
    $$(".nav-btn").forEach(b=>b.onclick=()=>navTo(b.dataset.view));
    
// ---- IMPOSTAZIONI STRIPE ----
async function loadImpostazioni() {
  const statusEl = $("#stripeStatus");
  const connectBtn = $("#btnConnectStripe");
  const disconnectBtn = $("#btnDisconnectStripe");

  const docRef = doc(db, "locali", LOCALE);
  const snap = await getDoc(docRef).catch(()=>null);

  if (snap && snap.exists() && snap.data().stripeAccountId) {
    statusEl.textContent = "Stato: collegato ✅ (" + snap.data().stripeAccountId + ")";
    connectBtn.classList.add("hidden");
    disconnectBtn.classList.remove("hidden");
  } else {
    statusEl.textContent = "Stato: non collegato ❌";
    connectBtn.classList.remove("hidden");
    disconnectBtn.classList.add("hidden");
  }

  connectBtn.onclick = () => {
    window.location.href = "/api/create-stripe-link?locale=" + LOCALE;
  };

  disconnectBtn.onclick = async () => {
    await setDoc(docRef, { stripeAccountId: null }, { merge: true });
    loadImpostazioni();
  };
}

function switchView(v){
      document.body.dataset.view = v;
      $$(".view").forEach(x=>x.classList.add("hidden"));
      $("#view-"+v).classList.remove("hidden");
      if(v==="home") { loadHome(); showOrderPane(true); }
      if(v==="tavoli") { loadTavoli(); showOrderPane(false); }
      if(v==="statistiche") { showOrderPane(false); }
      if(v==="impostazioni") { loadImpostazioni(); showOrderPane(false); }
      updateHeaderButton(); updateWhatsappQR();
    }

    // ---- CONTEXT ----
    function markCameFromTable(on){ cameFromTable = !!on; updateHeaderButton(); updateWhatsappQR(); }
    function updateHeaderButton(){
      const btn = $("#btnAddToTable");
      const cancel = $("#btnCancelTable");
      const badge = $("#modeBadge");
      const inHome = !$("#view-home").classList.contains("hidden");
      const show = inHome && cameFromTable && !!selectedTable;
      btn.classList.toggle("hidden", !show);
      cancel.classList.toggle("hidden", !show);
      badge.textContent = show ? (selectedTable?.tavoloNome || "Tavolo") : "Vendita diretta";
      if(!btn._wired){
        btn._wired = true;
        btn.onclick = ()=>{ try{ carrello = []; renderCart(); }catch(e){} selectedTable = null; markCameFromTable(false); updateHeaderButton(); updateWhatsappQR(); };
      }
      if(!cancel._wired){
        cancel._wired = true;
        cancel.onclick = ()=>{ try{ carrello = []; renderCart(); }catch(e){} selectedTable = null; markCameFromTable(false); updateHeaderButton(); updateWhatsappQR(); };
      }
    }
    function showOrderPane(show){
      const pane = document.getElementById('orderPane');
      if (!pane) return;
      pane.classList.toggle('hidden', !show);
    }
    navTo((location.hash||"#home").replace("#",""));

    // ---- CARRELLO (UI only) ----
    let carrello = []; // {id, nome, prezzo, quantita}
    function updateSelectedVisual(){
      document.querySelectorAll(".card[data-id]").forEach(el => {
        const id = el.getAttribute("data-id");
        const item = carrello.find(p => p.id === id);
        const badge = el.querySelector(".qty-badge");
        if (item){
          el.classList.add("selected");
          if (badge) badge.textContent = "x" + item.quantita;
        } else {
          el.classList.remove("selected");
          if (badge) badge.textContent = "";
        }
      });
      // Wire the bottom-center × remove button
      document.querySelectorAll(".card[data-id] .remove-btn").forEach(btn => {
        btn.onclick = (e)=>{
          e.stopPropagation();
          const card = btn.closest(".card");
          const id = card.getAttribute("data-id");
          const idx = carrello.findIndex(p => p.id === id);
          if (idx >= 0){
            carrello[idx].quantita--;
            if (carrello[idx].quantita <= 0){ carrello.splice(idx,1); }
            renderCart();
            try{ updateSelectedVisual(); }catch(e){}
          }
        };
      });
    }

    
function renderCart(){
  const list = $("#cartList");
  const empty = $("#emptyCart");
  list.innerHTML = "";
  empty.style.display = carrello.length ? "none":"block";
  carrello.forEach((p, idx)=>{
    const row = document.createElement("div");
    row.className = "cart-item";
    const thumbHTML = p.img ? `<img src="${p.img}" alt="">` : "<span>🍔</span>";
    row.innerHTML = `
      <div class="cart-thumb">${thumbHTML}</div>
      <div class="cart-name">
        ${p.nome}
        <span class="cart-qtytext">x${p.quantita}</span>
      </div>
      <div class="cart-price">€ ${money(p.prezzo * p.quantita)}</div>
      <div class="qty-vertical">
        <button class="btn-plus" data-act="inc">+</button>
        <button class="btn-minus" data-act="dec">−</button>
      </div>
    `;
    row.querySelector('[data-act="inc"]').onclick=()=>{ p.quantita++; renderCart(); };
    row.querySelector('[data-act="dec"]').onclick=()=>{ p.quantita--; if(p.quantita<=0){ carrello.splice(idx,1); } renderCart(); };
    list.appendChild(row);
  });
  const totale = carrello.reduce((s,p)=> s + (p.prezzo||0)*(p.quantita||1), 0);
  $("#totale").textContent = money(totale);
  try{ updateSelectedVisual(); }catch(e){}
}


    
    function addToCart(item){
      const i = carrello.findIndex(x=>x.id===item.id);
      if(i>=0) carrello[i].quantita += 1;
      else carrello.push({...item, quantita:1});
      renderCart();
      updateHeaderButton(); updateWhatsappQR();
      try{ updateSelectedVisual(); }catch(e){}
    }


    async function loadHome(){ await renderCategorieGruppi(); await renderSezioni(); }
    async function renderCategorieGruppi(){
      const wrap = $("#cats"); wrap.innerHTML="";
      const docRef = doc(db, "locali", LOCALE, "menu", "categorie");
      const snap = await getDoc(docRef).catch(()=>null);
      if(!snap || !snap.exists()){ wrap.innerHTML = "<span class='muted'>Nessuna categoria</span>"; return; }
      const data = snap.data();
      const groups = Object.keys(data);
      const row = document.createElement("div"); row.className="cats"; wrap.appendChild(row);
      groups.forEach(g=>{
        const arr = Array.isArray(data[g]) ? data[g] : [];
        arr.forEach(item=>{
          const key = item.originale || item.it || item.en;
          const label = item.it || item.en || key;
          const b = document.createElement("button");
          b.className = "cat-chip"; b.textContent = label;
          b.onclick = ()=> scrollToSection(key);
          row.appendChild(b);
        });
      });
    }
    async function renderSezioni(){
      const root = $("#sections"); root.innerHTML="";
      const docRef = doc(db, "locali", LOCALE, "menu", "categorie");
      const snap = await getDoc(docRef).catch(()=>null);
      if(!snap || !snap.exists()){ root.innerHTML = ""; return; }
      const data = snap.data();
      const allKeys = [];
      Object.keys(data).forEach(g => {
        (Array.isArray(data[g])?data[g]:[]).forEach(item => {
          const key = item.originale || item.it || item.en;
          const label = item.it || item.en || key;
          allKeys.push({key, label});
        });
      });

      for (const {key,label} of allKeys){
        const sec = document.createElement("div");
        sec.id = "sec-"+key;
        const title = document.createElement("div");
        title.className = "section-label";
        title.textContent = label.toLowerCase();
        sec.appendChild(title);

        const grid = document.createElement("div"); grid.className="products"; sec.appendChild(grid);
        const prodRef = collection(db, "locali", LOCALE, "menu", key, "prodotti");
        const snapP = await getDocs(prodRef).catch(()=>({docs:[]}));
        snapP.docs.forEach(d=>{
          const p = d.data();
          const card = document.createElement("div"); card.className="card";
          card.setAttribute("data-id", d.id);
          const imgHTML = p.immagineUrl ? `<img src="${p.immagineUrl}" alt="">` : "<span>🍔</span>";
          card.innerHTML = `
            <div class="img">${imgHTML}</div>
            <div class="meta">
              <div class="name">${(p.nome && (p.nome.it||p.nome.en||p.nome)) || d.id}</div>
            </div>
            <div class="price">€ ${(Number(p.prezzo)||0).toFixed(2)}</div>
            <button>Aggiungi</button>
            <span class="qty-badge"></span>
            <button class="remove-btn">×</button>
        
`;
          const itemPayload = { id: d.id, nome: (p.nome && (p.nome.it||p.nome.en||p.nome)) || d.id, prezzo: Number(p.prezzo)||0, categoria: key, img: p.immagineUrl || null };
card.querySelector("button").onclick = ()=> addToCart(itemPayload);
card.addEventListener("click", (ev)=>{
  if (ev.target && ev.target.closest("button")) return; // skip if actual button
  addToCart(itemPayload);
});
grid.appendChild(card);
        });
        root.appendChild(sec);
      }
    }
    function scrollToSection(key){
      const el = document.getElementById("sec-"+key);
      if(!el) return;
      const top = el.getBoundingClientRect().top + window.scrollY - 90;
      window.scrollTo({top, behavior:"smooth"});
      $$(".cat-chip").forEach(x=>x.classList.remove("active"));
      const chip = Array.from(document.querySelectorAll(".cat-chip")).find(c => (c.textContent||'').toLowerCase() === (el.querySelector(".section-label").textContent||'').toLowerCase());
      if (chip) chip.classList.add("active");
    }

    async function loadTavoli(){
      $("#saleTabs").innerHTML=""; $("#tavoliGrid").innerHTML="";
      const saleSnap=await getDocs(collection(db,"locali",LOCALE,"sale")).catch(()=>({docs:[]}));
      const ids=saleSnap.docs.map(d=>d.id);
      if(!ids.length){ $("#saleTabs").innerHTML="<p class='muted'>Nessuna sala</p>"; return; }
      if(!currentSala) currentSala=ids[0];
      ids.forEach(id=>{
        const b=document.createElement("button"); b.textContent=id; if(id===currentSala)b.classList.add("active");
        b.onclick=()=>{currentSala=id; $$("#saleTabs button").forEach(x=>x.classList.remove("active")); b.classList.add("active"); renderTavoli(id);};
        $("#saleTabs").appendChild(b);
      });
      renderTavoli(currentSala);
    }
    async function renderTavoli(salaId){
      const grid=$("#tavoliGrid"); grid.innerHTML="";
      const snap=await getDocs(collection(db,"locali",LOCALE,"sale",salaId,"tavoli")).catch(()=>({docs:[]}));
      if(!snap.docs.length){ grid.innerHTML="<p>Nessun tavolo</p>"; return; }
      const parseNum = v => { const m=String(v||"").match(/\d+/); return m?parseInt(m[0],10):0; };
      snap.docs.slice().sort((a,b)=>parseNum(a.data().nome||a.id)-parseNum(b.data().nome||b.id)).forEach(docu=>{
        const d=docu.data();
        const occ=d?.stato==="occupato"||d?.occupato===true;
        const card=document.createElement("div");
        card.className="tavolo-card";
        card.innerHTML=`
          <div class="tavolo-badge">T</div>
          <div class="tavolo-meta">
            <p class="tavolo-name">${d?.nome||docu.id}</p>
            <div class="tavolo-stato" style="color:${occ?'#d63031':'#00b894'}">${occ?'Occupato':'Libero'}</div>
          </div>
        `;
        card.onclick=()=>{
          selectedTable = { salaId, tavoloId: docu.id, tavoloNome: d?.nome||docu.id };
          markCameFromTable(true);
          selectedTable = { salaId, tavoloId: docu.id, tavoloNome: d?.nome||docu.id };
          markCameFromTable(true);
          const t = document.getElementById('popupTavoloTitle');
          if(t) t.textContent = 'Tavolo ' + (d?.nome||docu.id);
          const tot = document.getElementById('popupTavoloTotale');
          if(tot) tot.textContent = '0,00 €';
          const popup = document.getElementById('popupTavolo');
          if(popup) popup.style.display='flex';
        };
        grid.appendChild(card);
      });
    }

    // ===== Subtotale popup logic (UI only) =====
    const fmtEU = n => (Number(n)||0).toLocaleString('it-IT', {minimumFractionDigits:2, maximumFractionDigits:2});
    function cartTotal(){ return carrello.reduce((s,p)=> s + (p.prezzo||0)*(p.quantita||1), 0); }

    const subBackdrop = $("#subBackdrop");
    const subAmount = $("#subAmount");
    const subDiff = $("#subDiff");
    const subFinal = $("#subFinal");
    let subInput = "";  // stringa digitata
    let baseTot = 0;

    function openSub(){
      baseTot = cartTotal();
      subInput = "";
      subAmount.textContent = fmtEU(0);
      subDiff.textContent = fmtEU(0);
      subFinal.textContent = fmtEU(baseTot);
      subBackdrop.style.display = "flex";
    }
    function closeSub(){ subBackdrop.style.display = "none"; }

    function recompute(){
      const entered = Number(subInput.replace(',', '.')) || 0;
      subAmount.textContent = fmtEU(entered);
      const diff = entered - baseTot;
      subDiff.textContent = fmtEU(diff);
      subFinal.textContent = fmtEU(entered); // nel mock il totale coincide col subtotale scelto
    }

    // Bind buttons
    $("#btnSubtotale").onclick = openSub;
    $("#subConfirm").onclick = closeSub;
    $("#subCloseX").onclick = closeSub;
    subBackdrop.addEventListener('click', (e)=>{ if(e.target===subBackdrop) closeSub(); });

    $$(".key").forEach(k=>{
      k.addEventListener('click', ()=>{
        const t = k.textContent.trim();
        if(k.classList.contains('clear')){ subInput=""; }
        else { subInput += t; }
        recompute();
      });
    });
    $$(".pct-btn").forEach(b=>{
      b.addEventListener('click', ()=>{
        const pct = Number(b.dataset.pct);
        const val = baseTot * (1 + pct);
        subInput = String(Math.round(val*100)/100);
        recompute();
      });
    });

    // Buttons (placeholders for others)
    
    // ===== Pagamento modal (AGGIUNTA) =====
    const payBackdrop = $("#payBackdrop");
    function openPay(){
      const tot = cartTotal();
      $("#payTot").textContent = fmtEU(tot);
      const paid = 0;
      $("#payPaid").textContent = fmtEU(paid);
      $("#payDue").textContent = fmtEU(tot - paid);
      payBackdrop.style.display = "flex";
    }
// ====== Logiche Modalità Pagamento ======
function buildParzialeUI(){
  const dyn = document.getElementById("payDynamic");
  dyn.innerHTML = '<div style="text-align:center;margin:8px 0;font-weight:600">Inserisci importo:</div>'+
                  '<input id="partialInput" type="number" step="0.01" style="width:100%;padding:12px;font-size:20px;text-align:center;border-radius:10px;border:1px solid #ccc">';
}
function buildRomanaUI(){
  const dyn = document.getElementById("payDynamic");
  dyn.innerHTML = '<div class="romana-wrapper">Dividi per <input id="romanaPeople" type="number" min="1" value="2"> persone</div>'+
                  '<div id="romanaQuota"></div>';
  const inp = document.getElementById("romanaPeople");
  inp.addEventListener("input", ()=>{
    const n = parseInt(inp.value)||1;
    const tot = cartTotal();
    const quota = tot/n;
    document.getElementById("romanaQuota").textContent = "Quota: € " + fmtEU(quota);
    document.getElementById("payDue").textContent = fmtEU(quota);
    document.getElementById("payPaid").textContent = fmtEU(0);
  });
  inp.dispatchEvent(new Event("input"));
}
function buildSeparataUI(){
  const dyn = document.getElementById("payDynamic");
  dyn.innerHTML = '<div class="muted">Seleziona i prodotti da pagare:</div>';
  const items = Array.from(document.querySelectorAll("#cartList .cart-item"));
  if(items.length === 0){
    dyn.innerHTML += '<p class="muted">Nessun prodotto nel carrello.</p>';
    return;
  }
  items.forEach(it=>{
    const name = (it.querySelector(".cart-name,.tit")?.textContent || "Prodotto").trim();
    const priceText = (it.querySelector(".cart-price,.price")?.textContent || "€0,00").replace("€","").trim();
    const val = parseFloat(priceText.replace(".", "").replace(",", ".")) || 0;
    const row = document.createElement('div');
    row.className = 'pay-sep-row';
    row.innerHTML = '<div>'+name+'</div>'+
                    '<div>€'+ fmtEU(val) +'</div>'+
                    '<input type="checkbox" class="pay-sep-check" data-value="'+val+'">';
    row.addEventListener("click", e=>{
      if(e.target.tagName.toLowerCase()==="input") return;
      const cb = row.querySelector("input");
      cb.checked = !cb.checked;
      cb.dispatchEvent(new Event("change",{bubbles:true}));
    });
    const cb = row.querySelector("input");
    cb.addEventListener("change", ()=>{
      row.classList.toggle("selected", cb.checked);
      updateSeparataDue();
    });
    dyn.appendChild(row);
  });
  updateSeparataDue();
}
function updateSeparataDue(){
  const all = Array.from(document.querySelectorAll('#payDynamic .pay-sep-check:checked'));
  const sum = all.reduce((acc,cb)=> acc + (parseFloat(cb.dataset.value||'0')), 0);
  document.getElementById("payDue").textContent = fmtEU(sum);
  document.getElementById("payPaid").textContent = fmtEU(0);
}

    function closePay(){ payBackdrop.style.display = "none"; }

    $("#btnPagamento").onclick = openPay;
    $("#payClose").onclick = closePay;
    payBackdrop.addEventListener('click', (e)=>{ if(e.target===payBackdrop) closePay(); });

    $$(".segmented .seg").forEach(seg=>seg.addEventListener('click',()=>{
      $$(".segmented .seg").forEach(s=>s.classList.remove('active'));
      seg.classList.add('active');
    }));
    $$(".tabs-pay button").forEach(b=>b.addEventListener("click",()=>{
  $$(".tabs-pay button").forEach(x=>x.classList.remove("active"));
  b.classList.add("active");
  const mode = b.dataset.mode;
  const dyn = document.getElementById("payDynamic");
  if(dyn) dyn.innerHTML = "";
  if(mode==="parziale"){ buildParzialeUI(); }
  if(mode==="romana"){ buildRomanaUI(); }
  if(mode==="separata"){ buildSeparataUI(); }
}));
    $("#btnCash").onclick=()=>alert("Contanti");
    $("#btnCard").onclick=()=>alert("Carte");
    $("#btnOther").onclick=()=>alert("Altro");
    
    $("#btnPrepara").onclick = ()=> alert("Prepara (solo UI).");

    // First render of cart
    renderCart();
  
// ---- STRIPE WIZARD FULL ----
function initStripeWizard() {
  const steps = document.querySelectorAll("#stripeWizard .wizard-step");
  let currentStep = 1;
  const data = {};

  function showStep(step) {
    steps.forEach(s => s.classList.remove("active"));
    const active = document.querySelector(`#stripeWizard .wizard-step[data-step="${step}"]`);
    if(active) active.classList.add("active");
    currentStep = step;
    updateProgress(step);

    if(step === 4) {
      document.getElementById("confirmAccountType").textContent = data.accountType || "-";
      document.getElementById("confirmFirstName").textContent = data.firstName || "-";
      document.getElementById("confirmLastName").textContent = data.lastName || "-";
      document.getElementById("confirmEmail").textContent = data.email || "-";
      document.getElementById("confirmDob").textContent = data.dob || "-";
      document.getElementById("confirmAddress").textContent = data.address || "-";
      document.getElementById("confirmPostal").textContent = data.postal || "-";
      document.getElementById("confirmCity").textContent = data.city || "-";
      document.getElementById("confirmProvince").textContent = data.province || "-";
      document.getElementById("confirmPhone").textContent = data.phone || "-";
      document.getElementById("confirmCurrency").textContent = data.currency || "-";
      document.getElementById("confirmBankCountry").textContent = data.bankCountry || "-";
      document.getElementById("confirmIBAN").textContent = data.iban || "-";
    }
  }

  document.querySelectorAll("#stripeWizard .next-step").forEach(btn => {
    btn.addEventListener("click", () => {
      if(currentStep === 1) {
        data.accountType = document.getElementById("accountType").value;
      }
      if(currentStep === 2) {
        data.firstName = document.getElementById("firstName").value;
        data.lastName = document.getElementById("lastName").value;
        data.email = document.getElementById("email").value;
        data.dob = document.getElementById("dob").value;
        data.address = document.getElementById("address").value;
        data.postal = document.getElementById("postal").value;
        data.city = document.getElementById("city").value;
        data.province = document.getElementById("province").value;
        data.phone = document.getElementById("phone").value;
      }
      if(currentStep === 3) {
        data.currency = document.getElementById("currency").value;
        data.bankCountry = document.getElementById("bankCountry").value;
        data.iban = document.getElementById("iban").value;
        let ibanConfirm = document.getElementById("ibanConfirm").value;
        if(data.iban !== ibanConfirm) {
          alert("Gli IBAN non coincidono!");
          return;
        }
      }
      showStep(currentStep+1);
    });
  });

  document.querySelectorAll("#stripeWizard .prev-step").forEach(btn => {
    btn.addEventListener("click", () => showStep(currentStep-1));
  });

  showStep(1);
  updateProgress(1);
}

document.addEventListener("DOMContentLoaded", initStripeWizard);


// ---- UPDATE PROGRESS BAR ----
function updateProgress(step) {
  const dots = document.querySelectorAll("#wizardProgress .step-dot");
  dots.forEach(dot => {
    const s = parseInt(dot.getAttribute("data-step"));
    dot.classList.remove("active", "completed");
    if(s < step) dot.classList.add("completed");
    if(s === step) dot.classList.add("active");
  });
}


// ---- WhatsApp QR visibility only in 'impostazioni' ----
function updateWhatsappQR(){
  var qr = document.getElementById('whatsapp-assistenza');
  if(!qr) return;
  var current = document.body && document.body.dataset ? document.body.dataset.view : null;
  qr.style.display = (current === 'impostazioni') ? 'block' : 'none';
}

// Attach to nav and on load
document.addEventListener('DOMContentLoaded', function(){
  updateWhatsappQR();
  // Also attach to nav buttons if present
  document.querySelectorAll('.nav-btn[data-view]').forEach(function(btn){
    btn.addEventListener('click', function(){
      // Defer to allow switchView to change dataset
      setTimeout(updateWhatsappQR, 0);
    });
  });
});

</script>

  <!-- ===== POPUP TAVOLO (REINSERITO) ===== -->
  <div id="popupTavolo" style="display:none;position:fixed;inset:0;z-index:100;background:rgba(0,0,0,.4);align-items:center;justify-content:center;">
    <div style="background:#fff;border-radius:12px;box-shadow:0 8px 24px rgba(0,0,0,.2);width:min(480px,90%);padding:16px;">
      <div style="display:flex;justify-content:space-between;align-items:center;margin-bottom:12px;">
        <h3 id="popupTavoloTitle" style="margin:0;font-size:18px;font-weight:700;">Tavolo</h3>
        <button id="popupTavoloClose" class="btn secondary">Chiudi</button>
      </div>
      <div id="popupTavoloContent" style="padding:8px 0;color:#555;">Nessun prodotto nel tavolo (tablet).</div>
      <div style="margin-top:12px;display:flex;justify-content:space-between;align-items:center;">
        <div style="font-weight:700;">Totale: <span id="popupTavoloTotale">0,00 €</span></div>
        <div style="display:flex;gap:8px;">
          <button id="popupTavoloAdd" class="btn">Aggiungi prodotti</button>
          <button id="popupTavoloPay" class="btn">Vai al pagamento</button>
        </div>
      </div>
    </div>
  </div>


  <script>
  // === HANDLER POPUP TAVOLO (reinseriti) ===
  (function(){
    const $ = (s,r=document)=>r.querySelector(s);
    const pop = $('#popupTavolo');
    const btnClose = $('#popupTavoloClose');
    const btnAdd = $('#popupTavoloAdd');
    const btnPay = $('#popupTavoloPay');
    if(btnClose){
      btnClose.onclick = ()=>{
        if(pop) pop.style.display='none';
        try{ selectedTable = null; markCameFromTable(false); updateHeaderButton(); updateWhatsappQR(); }catch(e){}
      };
    }
    if(btnAdd){
      btnAdd.onclick = ()=>{
        if(pop) pop.style.display='none';
        try { navTo('home'); } catch(e) { location.hash = '#home'; }
        try { markCameFromTable(true); updateHeaderButton(); updateWhatsappQR(); } catch(e) {}
      };
    }
    if(btnPay){
      btnPay.onclick = ()=>{
        if(pop) pop.style.display='none';
        alert('Funzione pagamento da implementare');
      };
    }
  })();
  </script>


<script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
<script type="module" id="stats-js">
// ====== Firebase (hook later) ======
// import { initializeApp } from "https://www.gstatic.com/firebasejs/10.12.2/firebase-app.js";
// import { getFirestore, collection, getDocs, query, where } from "https://www.gstatic.com/firebasejs/10.12.2/firebase-firestore.js";
// const firebaseConfig = {}; // <-- inserisci le tue chiavi
// const app = initializeApp(firebaseConfig);
// const db = getFirestore(app);

const state = {
  rangeDays: 30,
  from: null,
  to: null,
  category: 'all',
  localeId: 'zappydemo' // aggiornabile
};

// ==== UTILS ====
const fmtEur = (v)=> new Intl.NumberFormat('it-IT',{style:'currency', currency:'EUR'}).format(v||0);
const by = (sel)=> document.querySelector(sel);

// Generatore mock (verrà sostituito da Firestore)
function mockOrders(n=120){
  const cats = ['drink','birra','vino','analcoliche','panini','fritti','pizze'];
  const prods = {
    drink:['Moscow Mule','Gin Tonic','Gin Lemon','Negroni','Spritz','Vodka RedBull'],
    birra:['Pilsner','Stout','IPA','Lager'],
    vino:['Chianti','Chardonnay','Cabernet','Sauvignon'],
    analcoliche:['Coca Cola','Fanta','Sprite','Acqua Naturale','Acqua Frizzante'],
    panini:['Cheeseburger','Panino Vegetale','Panino Piccante','Bacon Burger','Panino Uovo','Chicken Burger'],
    fritti:['Arancini','Anelli di cipolla','Nachos','Mozzarella Sticks','Frittelle','Patatine Fritte'],
    pizze:['4 Stagioni','Bufalina','Diavola','Margherita','Homer','Ciclista']
  };
  const price = (name)=> {
    const base = {
      'Moscow Mule':6,'Gin Tonic':6,'Gin Lemon':6,'Negroni':6,'Spritz':4.5,'Vodka RedBull':6,
      'Pilsner':3,'Stout':5,'IPA':5,'Lager':4,
      'Chianti':3.5,'Chardonnay':3.5,'Cabernet':4,'Sauvignon':3.5,
      'Coca Cola':3,'Fanta':3,'Sprite':2.5,'Acqua Naturale':1,'Acqua Frizzante':1,
      'Cheeseburger':7.5,'Panino Vegetale':6,'Panino Piccante':7,'Bacon Burger':7.8,'Panino Uovo':7.5,'Chicken Burger':7,
      'Arancini':4,'Anelli di cipolla':3.5,'Nachos':4,'Mozzarella Sticks':4.5,'Frittelle':3.5,'Patatine Fritte':3,
      '4 Stagioni':8,'Bufalina':8,'Diavola':7.5,'Margherita':6,'Homer':8,'Ciclista':5.5
    };
    return base[name] ?? 5;
  };
  const arr=[];
  for(let i=0;i<n;i++){
    const d = new Date();
    d.setDate(d.getDate() - Math.floor(Math.random()*state.rangeDays));
    d.setHours(Math.floor(Math.random()*12)+12); // 12-23
    const cat = cats[Math.floor(Math.random()*cats.length)];
    const names = prods[cat];
    const itemsCount = 1+Math.floor(Math.random()*3);
    const prodotti=[];
    for(let k=0;k<itemsCount;k++){
      const name = names[Math.floor(Math.random()*names.length)];
      const q = 1+Math.floor(Math.random()*2);
      prodotti.push({ nome:name, categoria:cat, quantita:q, prezzo:price(name) });
    }
    arr.push({ created_at: d.toISOString(), prodotti });
  }
  return arr;
}

// TODO: sostituire con Firestore
async function fetchOrders(){
  // Esempio per Firestore (quando abiliti):
  // let ref = collection(db, `locali/${state.localeId}/ordini`);
  // let q = ref; // aggiungi where su date se servono
  // const snap = await getDocs(q);
  // return snap.docs.map(d => d.data());
  return mockOrders(220);
}

// ===== CHARTS =====
let chartRevenue, chartProducts, chartCategory, chartHours;

function ensureCharts(){
  if(!chartRevenue){
    chartRevenue = new Chart(by('#chartRevenueOverTime'), { type:'line', data:{ labels:[], datasets:[{label:'Incasso', data:[], tension:0.35}] }, options:{ responsive:true } });
  }
  if(!chartProducts){
    chartProducts = new Chart(by('#chartTopProducts'), { type:'bar', data:{ labels:[], datasets:[{label:'Q.tà', data:[]}] }, options:{ indexAxis:'y', responsive:true } });
  }
  if(!chartCategory){
    chartCategory = new Chart(by('#chartByCategory'), { type:'doughnut', data:{ labels:[], datasets:[{data:[]}] }, options:{ responsive:true, cutout:'60%'} });
  }
  if(!chartHours){
    chartHours = new Chart(by('#chartOrdersByHour'), { type:'bar', data:{ labels:[], datasets:[{label:'Ordini/ora', data:[]}] }, options:{ responsive:true } });
  }
}

// ===== RENDER =====
async function renderStats(){
  const orders = await fetchOrders();

  // Filtra per categoria se necessario
  const filtered = state.category==='all' ? orders : orders.map(o=>({
    ...o,
    prodotti: o.prodotti.filter(p=>p.categoria===state.category)
  })).filter(o=>o.prodotti.length>0);

  // Aggregazioni
  let totalRevenue = 0, totalOrders = filtered.length;
  const productCounts = new Map();
  const productRevenue = new Map();
  const categoryCounts = new Map();
  const revenueByDay = new Map();
  const ordersByHour = new Array(24).fill(0);

  for(const o of filtered){
    const d = new Date(o.created_at);
    const dayKey = d.toISOString().slice(0,10);
    let orderSum = 0;
    for(const p of o.prodotti){
      totalRevenue += p.prezzo * p.quantita;
      orderSum += p.prezzo * p.quantita;
      productCounts.set(p.nome, (productCounts.get(p.nome)||0)+p.quantita);
      productRevenue.set(p.nome, (productRevenue.get(p.nome)||0)+p.prezzo*p.quantita);
      categoryCounts.set(p.categoria, (categoryCounts.get(p.categoria)||0)+p.quantita);
    }
    revenueByDay.set(dayKey, (revenueByDay.get(dayKey)||0)+orderSum);
    ordersByHour[d.getHours()]++;
  }

  // KPI
  by('#totalRevenue').textContent = fmtEur(totalRevenue);
  by('#totalOrders').textContent = totalOrders;
  by('#avgTicket').textContent = totalOrders? fmtEur(totalRevenue/totalOrders) : '€0,00';

  const productsSorted = Array.from(productCounts.entries()).sort((a,b)=>b[1]-a[1]);
  const best = productsSorted[0]?.[0] ?? '–';
  const worst = productsSorted[productsSorted.length-1]?.[0] ?? '–';
  by('#bestProduct').textContent = best;
  by('#worstProduct').textContent = worst;
  const peakHourIdx = ordersByHour.indexOf(Math.max(...ordersByHour));
  by('#peakHour').textContent = peakHourIdx>=0 ? `${peakHourIdx}:00` : '–';

  // Charts
  ensureCharts();

  // Revenue over time
  const daysArr = Array.from(revenueByDay.entries()).sort((a,b)=>a[0].localeCompare(b[0]));
  chartRevenue.data.labels = daysArr.map(d=>d[0]);
  chartRevenue.data.datasets[0].data = daysArr.map(d=>d[1]);
  chartRevenue.update();

  // Top products (max 10)
  const top10 = productsSorted.slice(0,10);
  chartProducts.data.labels = top10.map(x=>x[0]);
  chartProducts.data.datasets[0].data = top10.map(x=>x[1]);
  chartProducts.update();

  // By category
  const cats = Array.from(categoryCounts.entries()).sort((a,b)=>b[1]-a[1]);
  chartCategory.data.labels = cats.map(x=>x[0]);
  chartCategory.data.datasets[0].data = cats.map(x=>x[1]);
  chartCategory.update();

  // Orders by hour (12–23 presenti nei mock)
  chartHours.data.labels = Array.from({length:24}, (_,i)=> i);
  chartHours.data.datasets[0].data = ordersByHour;
  chartHours.update();

  // Tables
  const tbodyTop = by('#tableTopProducts tbody'); tbodyTop.innerHTML='';
  const byRevenue = Array.from(productRevenue.entries()).sort((a,b)=>b[1]-a[1]).slice(0,15);
  byRevenue.forEach((row,i)=>{
    const [name, rev] = row;
    const qty = productCounts.get(name)||0;
    const tr = document.createElement('tr');
    tr.innerHTML = `<td>${i+1}</td><td>${name}</td><td>${qty}</td><td>${fmtEur(rev)}</td>`;
    tbodyTop.appendChild(tr);
  });
  const tbodyWorst = by('#tableWorstProducts tbody'); tbodyWorst.innerHTML='';
  const worst15 = productsSorted.slice(-15);
  worst15.forEach((row,i)=>{
    const [name, qty] = row;
    const rev = productRevenue.get(name)||0;
    const tr = document.createElement('tr');
    tr.innerHTML = `<td>${i+1}</td><td>${name}</td><td>${qty}</td><td>${fmtEur(rev)}</td>`;
    tbodyWorst.appendChild(tr);
  });
}

// Filters logic
document.addEventListener('click', (e)=>{
  if(e.target.id==='stats-refresh') renderStats();
});
document.addEventListener('change', (e)=>{
  if(e.target.id==='stats-range'){
    const val = e.target.value;
    const custom = val==='custom';
    document.getElementById('stats-from').classList.toggle('hidden', !custom);
    document.getElementById('stats-to').classList.toggle('hidden', !custom);
    state.rangeDays = custom ? 30 : parseInt(val,10);
  }
  if(e.target.id==='stats-category'){
    state.category = e.target.value;
  }
});

// Auto-render on first open if the section exists/visible
setTimeout(()=>{
  const sec = document.getElementById('view-statistiche');
  if(sec){ renderStats(); }
}, 200);
</script>





<!-- QR WhatsApp Assistenza (solo in Impostazioni) -->
<div id="whatsapp-assistenza" style="display:none; position: fixed; bottom: 20px; right: 20px; text-align: center; z-index: 999;">
  <p style="font-size: 14px; font-weight: 600; color:#333; margin-bottom:8px;">Scansiona il QR per contattarci</p>

  <a href="https://wa.me/393791243514" target="_blank" rel="noopener">
    <img src="https://api.qrserver.com/v1/create-qr-code/?size=140x140&data=https://wa.me/393791243514" 
         alt="QR WhatsApp" style="width:140px; height:140px; border-radius:12px; box-shadow:0 2px 6px rgba(0,0,0,0.3); background:#fff;">
  </a>

  <p style="font-size: 13px; color:#555; margin:8px 0;">oppure</p>

  <a href="https://wa.me/393791243514" target="_blank" rel="noopener" 
     style="display:flex; align-items:center; justify-content:center; gap:6px; margin-top:4px; padding:10px 14px; border-radius:10px; font-weight:600; font-size:14px; text-decoration:none; background:#25D366; color:#fff; box-shadow:0 2px 6px rgba(0,0,0,0.2);">
    <img src="https://upload.wikimedia.org/wikipedia/commons/6/6b/WhatsApp.svg" alt="WhatsApp" style="width:18px; height:18px;">
    Clicca qui
  </a>
</div>



</body>
</html>
